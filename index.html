<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spartizione Detriti — ACS</title>
<style>
  :root{
    --bg0:#07121f;
    --bg1:#0b1b2b;
    --bg2:#0e2236;
    --panel:#0d2135cc;
    --line:#1f3b57;
    --line2:#2a4b6a;
    --text:#e7f0ff;
    --muted:#9cb2cb;
    --accent:#f2c86d;
    --good:#75f0a7;
    --bad:#ff7b7b;
    --chip:#142f49;
    --shadow: 0 10px 30px rgba(0,0,0,.45);
    --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 70% 20%, rgba(53, 118, 120,.22), transparent 60%),
      radial-gradient(900px 500px at 20% 10%, rgba(162, 120, 44,.18), transparent 55%),
      linear-gradient(180deg, var(--bg0), #050b12 60%, #04080d);
  }
  .wrap{max-width:1250px;margin:0 auto;padding:24px 18px 60px}
  .top{
    display:flex;gap:14px;align-items:center;justify-content:space-between;
    padding:14px 16px;border:1px solid var(--line);border-radius:22px;
    background: linear-gradient(180deg, rgba(13,33,53,.85), rgba(8,18,31,.65));
    box-shadow: var(--shadow);
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{
    width:42px;height:42px;border-radius:14px;
    background: radial-gradient(circle at 30% 30%, rgba(242,200,109,.45), rgba(242,200,109,.05) 55%),
                linear-gradient(180deg, rgba(18,40,63,.95), rgba(7,18,31,.75));
    border:1px solid rgba(242,200,109,.35);
    position:relative;
  }
  .logo:after{
    content:"";
    position:absolute; inset:10px;
    border:1px dashed rgba(242,200,109,.35);
    border-radius:10px;
  }
  h1{font-size:22px;margin:0;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  button,.btn{
    appearance:none;border:1px solid rgba(42,75,106,.85);
    background: linear-gradient(180deg, rgba(18,40,63,.85), rgba(11,27,43,.75));
    color:var(--text); padding:10px 12px;border-radius:14px;
    font-weight:650; cursor:pointer; letter-spacing:.2px;
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
  }
  button:hover{border-color:rgba(242,200,109,.55)}
  .ghost{
    background: rgba(12,28,44,.45);
  }
  .warn{
    border-color: rgba(255,123,123,.55);
  }
  .grid{
    margin-top:16px;
    display:grid;
    grid-template-columns: 1.15fr .85fr;
    gap:14px;
  }
  .col{display:flex;flex-direction:column;gap:14px}
  details.panel{
    border:1px solid rgba(31,59,87,.95);
    border-radius:22px;
    background: linear-gradient(180deg, rgba(13,33,53,.85), rgba(7,18,31,.60));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  summary{
    list-style:none;
    display:flex;align-items:center;justify-content:space-between;
    padding:14px 16px; cursor:pointer;
    gap:10px;
  }
  summary::-webkit-details-marker{display:none}
  .sumL{display:flex;align-items:center;gap:10px;min-width:0}
  .title{font-size:18px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    font-size:12px;color:var(--muted);
    padding:6px 10px;border-radius:999px;
    background: rgba(20,47,73,.75);
    border:1px solid rgba(42,75,106,.55);
  }
  .chev{
    width:26px;height:26px;border-radius:10px;
    border:1px solid rgba(42,75,106,.55);
    display:flex;align-items:center;justify-content:center;
    color:var(--muted);
  }
  details[open] .chev{color:var(--accent); border-color: rgba(242,200,109,.45)}
  details[open] .chev:before{content:"▾"}
  details:not([open]) .chev:before{content:"▸"}
  .content{padding:0 16px 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .field{flex:1 1 220px; min-width:220px}
  label{display:block;color:var(--muted);font-size:12px;margin:8px 0 6px}
  input,select,textarea{
    width:100%;
    border:1px solid rgba(42,75,106,.8);
    background: rgba(8,18,31,.65);
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    outline:none;
  }
  textarea{min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
  input:focus,select:focus,textarea:focus{border-color: rgba(242,200,109,.55)}
  .note{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.35}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{color:var(--muted);font-size:12px;text-align:left;padding:0 10px}
  td{
    padding:10px 10px;
    background: rgba(9,22,36,.55);
    border:1px solid rgba(31,59,87,.75);
  }
  tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
  .num{text-align:right;font-variant-numeric: tabular-nums}
  .ok{color:var(--good);font-weight:800}
  .no{color:var(--bad);font-weight:800}
  .mini{font-size:11px;color:var(--muted)}
  .hr{height:1px;background: rgba(31,59,87,.85);margin:12px 0}
  .drag-handle{
    width:14px;height:14px;border-radius:6px;
    border:1px solid rgba(42,59,82,.8);
    background: rgba(20,38,59,.7);
    display:inline-flex;align-items:center;justify-content:center;
    cursor:grab; flex:0 0 auto;
  }
  .drag-handle:before{content:"⋮⋮";font-size:10px;line-height:1;color:var(--muted);letter-spacing:-2px;transform:rotate(90deg)}
  .dragging{opacity:.55;outline:2px dashed rgba(242,200,109,.35);outline-offset:-6px}
  .pillBtn{display:flex;gap:10px;align-items:end}
  .pillBtn button{height:42px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .k{
    flex:1 1 160px;
    background: rgba(9,22,36,.55);
    border:1px solid rgba(31,59,87,.75);
    border-radius:16px;
    padding:10px 12px;
  }
  .k .lab{color:var(--muted);font-size:11px}
  .k .val{font-weight:900;margin-top:6px;font-variant-numeric:tabular-nums}
  .footerRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px}
  .smallBtn{padding:8px 10px;border-radius:12px;font-size:12px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Spartizione Detriti — ACS</h1>
        <div class="sub">CR + RR via proxy, quote paritaria/equa, conguagli e trasporti finali.</div>
      </div>
    </div>
    <div class="actions">
      <button id="btnExample">Incolla esempio</button>
      <button id="btnCopy" class="ghost">Copia riepilogo</button>
      <button id="btnExport" class="ghost">Esporta JSON</button>
      <button id="btnImport" class="ghost">Importa JSON</button>
      <input id="fileImport" type="file" accept="application/json" style="display:none"/>
    </div>
  </div>

  <div class="grid">
    <div class="col" id="colA">
      <details class="panel" open data-panel-id="cr">
        <summary>
          <div class="sumL">
            <span class="drag-handle" title="Trascina per riordinare"></span>
            <div class="title">1) CR / Combat Report</div>
            <div class="chips"><span class="chip">input</span><span class="chip">apiid</span></div>
          </div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Proxy API base</label>
              <input id="proxyBase" placeholder="https://ogame-api-proxy.tuo.workers.dev/?apiid=" />
              <div class="note">Deve restituire testo RR/CR raw. Esempio: <span class="mini">https://ogame-api-proxy.matiasquiroz87.workers.dev/?apiid=</span></div>
            </div>
            <div class="field">
              <label>API ID (CR)</label>
              <input id="apiCrId" placeholder="cr-it-..." />
            </div>
            <div class="pillBtn">
              <div>
                <label>&nbsp;</label>
                <button id="btnLoadCR">Carica CR</button> <button id="btnTestCR" class="ghost">Test</button>
              </div>
              <div>
                <label>&nbsp;</label>
                <button id="btnToggleCR" class="ghost">Mostra/Nascondi</button>
              </div>
            </div>
          </div>
          <textarea id="cr" style="display:none" placeholder="(Debug) testo CR"></textarea>
          <div class="kpi" id="kpiCR">
            <div class="k"><div class="lab">Attaccanti</div><div class="val" id="kAtt">—</div></div>
            <div class="k"><div class="lab">DF Metallo</div><div class="val" id="kM">—</div></div>
            <div class="k"><div class="lab">DF Cristallo</div><div class="val" id="kC">—</div></div>
            <div class="k"><div class="lab">DF Deuterio</div><div class="val" id="kD">—</div></div>
          </div>
        </div>
      </details>

      <details class="panel" open data-panel-id="rr">
        <summary>
          <div class="sumL">
            <span class="drag-handle" title="Trascina per riordinare"></span>
            <div class="title">1b) RR / Raccolta Riciclatrici</div>
            <div class="chips"><span class="chip">input</span><span class="chip">owner_name</span></div>
          </div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Assegna RR</label>
              <select id="rrPlayer"></select>
              <div class="note">Auto usa <span class="mini">owner_name</span> (stdClass) o deduzione per coordinate se univoca.</div>
            </div>
            <div class="field">
              <label>Coordinate (opzionale, filtro)</label>
              <input id="rrCoord" placeholder="es. 2:96:8" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>API ID (RR)</label>
              <input id="apiRrId" placeholder="rr-it-..." />
            </div>
            <div class="pillBtn">
              <div>
                <label>&nbsp;</label>
                <button id="btnLoadRR">Carica RR</button> <button id="btnTestRR" class="ghost">Test</button>
              </div>
              <div>
                <label>&nbsp;</label>
                <button id="btnAddRR" class="ghost">Aggiungi RR</button>
              </div>
              <div>
                <label>&nbsp;</label>
                <button id="btnToggleRR" class="ghost">Mostra/Nascondi</button>
              </div>
            </div>
          </div>

          <textarea id="rr" style="display:none" placeholder="(Debug) testo RR"></textarea>

          <div class="hr"></div>

          <div style="overflow:auto; max-height:240px;">
            <table>
              <thead>
                <tr>
                  <th>Giocatore</th>
                  <th class="num">Raccolto M</th>
                  <th class="num">Raccolto C</th>
                  <th class="num">Raccolto D</th>
                  <th class="num">Totale</th>
                  <th class="num">Azioni</th>
                </tr>
              </thead>
              <tbody id="tbodyRR"></tbody>
            </table>
          </div>

          <div class="footerRow">
            <button id="btnClearRR" class="ghost smallBtn">Reset raccolte</button>
            <span class="mini">La raccolta RR viene usata per calcolare “Da regolare”.</span>
          </div>
        </div>
      </details>

      <details class="panel" open data-panel-id="result">
        <summary>
          <div class="sumL">
            <span class="drag-handle" title="Trascina per riordinare"></span>
            <div class="title">3) Risultato spartizione</div>
            <div class="chips"><span class="chip">output</span></div>
          </div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Modalità</label>
              <select id="mode">
                <option value="paritaria">Paritaria (uguale)</option>
                <option value="equa">Equa (proporzionale peso flotta)</option>
              </select>
            </div>
            <div class="field">
              <label>DF override (M / C / D)</label>
              <div class="row">
                <div class="field" style="min-width:160px;flex:1 1 160px"><input id="dfM" placeholder="0" inputmode="numeric"></div>
                <div class="field" style="min-width:160px;flex:1 1 160px"><input id="dfC" placeholder="0" inputmode="numeric"></div>
                <div class="field" style="min-width:160px;flex:1 1 160px"><input id="dfD" placeholder="0" inputmode="numeric"></div>
              </div>
            </div>
          </div>

          <div style="overflow:auto; max-height:320px; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>Giocatore</th>
                  <th class="num">Peso</th>
                  <th class="num">Quota M</th>
                  <th class="num">Quota C</th>
                  <th class="num">Quota D</th>
                  <th class="num">Raccolto</th>
                  <th class="num">Da regolare</th>
                </tr>
              </thead>
              <tbody id="tbodyRes"></tbody>
            </table>
          </div>

          <div class="note">“Da regolare” = quota (M+C+D) − raccolto (RR). Valori negativi = ha preso più della quota.</div>
        </div>
      </details>
    </div>

    <div class="col" id="colB">
      <details class="panel" open data-panel-id="settings">
        <summary>
          <div class="sumL">
            <span class="drag-handle" title="Trascina per riordinare"></span>
            <div class="title">2) Impostazioni</div>
            <div class="chips"><span class="chip">split</span></div>
          </div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Raccoglitore (chi redistribuisce)</label>
              <select id="collector"></select>
            </div>
            <div class="field">
              <label>Decimali (visualizzazione)</label>
              <select id="decimals">
                <option value="0">0</option>
                <option value="2" selected>2</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Capienza Cargo Leggeri</label>
              <input id="capLC" value="25000" inputmode="numeric">
            </div>
            <div class="field">
              <label>Capienza Cargo Pesanti</label>
              <input id="capSC" value="50000" inputmode="numeric">
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Strategia trasporto</label>
              <select id="strategy">
                <option value="SC_LC">SC → LC</option>
                <option value="LC_SC">LC → SC</option>
              </select>
              <div class="note">Calcolo puramente logistico: numero viaggi minimi con capienze fornite.</div>
            </div>
          </div>
        </div>
      </details>

      <details class="panel" open data-panel-id="transports">
        <summary>
          <div class="sumL">
            <span class="drag-handle" title="Trascina per riordinare"></span>
            <div class="title">4) Trasporti finali</div>
            <div class="chips"><span class="chip">logistica</span></div>
          </div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="note">Spedizioni dal raccoglitore ai giocatori con “Da regolare” &gt; 0.</div>
          <div style="overflow:auto; max-height:340px; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>Da → A</th>
                  <th class="num">Risorse</th>
                  <th class="num">Cargo Pesanti</th>
                  <th class="num">Cargo Leggeri</th>
                </tr>
              </thead>
              <tbody id="tbodyTx"></tbody>
            </table>
          </div>
        </div>
      </details>

      <details class="panel" data-panel-id="debug">
        <summary>
          <div class="sumL">
            <span class="drag-handle" title="Trascina per riordinare"></span>
            <div class="title">Note parsing</div>
            <div class="chips"><span class="chip">debug</span></div>
          </div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="note" id="debug">—</div>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  // ---------- state ----------
  const STATE_KEY = "ogame_spartizione_rebuild_v1";
  const PANEL_KEY = "ogame_spartizione_panel_order_rebuild_v1";

  let state = {
    proxyBase: "https://ogame-api-proxy.matiasquiroz87.workers.dev/?apiid=",
    crText: "",
    rrText: "",
    attackers: [], // {name, ships:{}, weight, collected:{m,c,d}, share:{m,c,d}, settle:{m,c,d}, settleTotal}
    df: {m:0,c:0,d:0},
    mode: "paritaria",
    collector: "",
    rrLog: [] // {player,coord,m,c,d}
  };

  // ---------- helpers ----------
  function parseIntOgame(s){
    if(s==null) return 0;
    const str = String(s).trim();
    if(!str) return 0;
    // remove dots as thousands separators, keep commas as decimals -> but we want int
    const norm = str.replace(/\./g,"").replace(/,/g,"");
    const n = Number(norm);
    return Number.isFinite(n) ? n : 0;
  }
  function fmt(n, dec=0){
    const x = Number(n||0);
    const d = Number(dec||0);
    return x.toLocaleString("it-IT",{minimumFractionDigits:d, maximumFractionDigits:d});
  }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function setDebug(msg){ $("debug").textContent = msg; }

  // ---------- persistence ----------
  function saveState(){
    const safe = {
      proxyBase: state.proxyBase,
      attackers: state.attackers.map(a=>({
        name:a.name, weight:a.weight,
        collected:a.collected||{m:0,c:0,d:0}
      })),
      df: state.df, mode: state.mode, collector: state.collector, rrLog: state.rrLog
    };
    localStorage.setItem(STATE_KEY, JSON.stringify(safe));
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw) return;
      const s = JSON.parse(raw);
      if(s.proxyBase) state.proxyBase = s.proxyBase;
      if(s.df) state.df = s.df;
      if(s.mode) state.mode = s.mode;
      if(s.collector) state.collector = s.collector;
      if(Array.isArray(s.rrLog)) state.rrLog = s.rrLog;
    }catch(e){}
  }

  // ---------- drag & drop panels ----------
  function getPanelOrder(){
    try{
      const raw = localStorage.getItem(PANEL_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){return null;}
  }
  function savePanelOrder(){
    const cols = [$("colA"), $("colB")];
    const data = {};
    cols.forEach((col, idx)=>{
      const ids = Array.from(col.querySelectorAll("details.panel[data-panel-id]")).map(d=>d.getAttribute("data-panel-id"));
      data["col"+idx]=ids;
    });
    localStorage.setItem(PANEL_KEY, JSON.stringify(data));
  }
  function applyPanelOrder(){
    const order = getPanelOrder();
    if(!order) return;
    const cols = [$("colA"), $("colB")];
    cols.forEach((col, idx)=>{
      const key = "col"+idx;
      const ids = order[key];
      if(!Array.isArray(ids)) return;
      const map = new Map();
      Array.from(col.querySelectorAll("details.panel[data-panel-id]")).forEach(d=>map.set(d.getAttribute("data-panel-id"), d));
      ids.forEach(id=>{ const el=map.get(id); if(el) col.appendChild(el); });
      map.forEach((el,id)=>{ if(!ids.includes(id)) col.appendChild(el); });
    });
  }
  function setupDragAndDrop(){
    const cols = [$("colA"), $("colB")];
    let dragEl = null;

    cols.forEach(col=>{
      col.querySelectorAll("details.panel[data-panel-id] > summary").forEach(sum=>{
        const handle = sum.querySelector(".drag-handle");
        if(!handle) return;
        handle.draggable = true;

        handle.addEventListener("dragstart",(ev)=>{
          dragEl = sum.parentElement;
          dragEl.classList.add("dragging");
          ev.dataTransfer.effectAllowed = "move";
          ev.dataTransfer.setData("text/plain", dragEl.getAttribute("data-panel-id")||"");
        });
        handle.addEventListener("dragend", ()=>{
          if(dragEl) dragEl.classList.remove("dragging");
          dragEl=null;
          savePanelOrder();
        });
      });

      col.addEventListener("dragover",(ev)=>{
        if(!dragEl) return;
        ev.preventDefault();
        const after = getAfter(col, ev.clientY);
        if(after==null) col.appendChild(dragEl);
        else col.insertBefore(dragEl, after);
      });
      col.addEventListener("drop",(ev)=>{
        if(!dragEl) return;
        ev.preventDefault();
        savePanelOrder();
      });
    });

    function getAfter(container, y){
      const els = [...container.querySelectorAll("details.panel[data-panel-id]:not(.dragging)")];
      let closest = {offset: Number.NEGATIVE_INFINITY, el:null};
      for(const child of els){
        const box = child.getBoundingClientRect();
        const offset = y - (box.top + box.height/2);
        if(offset < 0 && offset > closest.offset){
          closest = {offset, el: child};
        }
      }
      return closest.el;
    }
  }

  // ---------- API ----------
  async function loadFromApi(apiId){
    const base = ($("proxyBase").value.trim() || state.proxyBase);
    const url = base + encodeURIComponent(apiId);
    const res = await fetch(url);
    const txt = await res.text();
    return {status: res.status, ok: res.ok, url, text: txt};
  }

  // ---------- parsing CR ----------
  const SHIP_COST = {
    "Cargo leggero": 2000+2000, "Cargo Pesante": 6000+6000, "Caccia Leggero": 3000+1000,
    "Caccia Pesante": 6000+4000, "Incrociatore": 20000+7000, "Nave da battaglia": 45000+15000,
    "Colonizzatrice": 10000+20000, "Riciclatrice": 10000+6000, "Sonda spia": 0+1000,
    "Bombardiere": 50000+25000, "Satellite Solare": 0, "Corazzata": 30000+40000,
    "Morte Nera": 5000000+4000000, "Incrociatore da Battaglia": 30000+40000,
    "Crawler": 2000000+1500000, "Reaper": 85000+55000, "Pathfinder": 8000+15000
  };

  function parseCR(text){
    const t = String(text||"");

    // --- A) CR "testo classico" (IT/EN)
    if(/\bAttaccante\b/i.test(t) && /\bDopo la battaglia\b/i.test(t)){
      const attackers = [];
      let current = null;
      let inAfter = false;

      const lines = t.split(/\r?\n/);
      const reAtt = /^Attaccante\s+(.+?)\s+\[/i;
      const reAfter = /^Dopo la battaglia/i;

      for(const raw of lines){
        const line = raw.trim();
        if(!line) continue;
        if(reAfter.test(line)) { inAfter = true; current = null; continue; }
        if(inAfter) continue;

        const m = line.match(reAtt);
        if(m){
          if(current) attackers.push(current);
          current = {
            name: m[1].trim(),
            ships:{},
            weight:0,
            collected:{m:0,c:0,d:0},
            share:{m:0,c:0,d:0},
            settle:{m:0,c:0,d:0},
            settleTotal:0
          };
          continue;
        }
        if(!current) continue;

        const shipMatch = line.match(/^([A-Za-zÀ-ÖØ-öø-ÿ\s]+)\s+([\d\.\,]+)$/);
        if(shipMatch){
          const ship = shipMatch[1].trim();
          const qty = parseIntOgame(shipMatch[2]);
          current.ships[ship] = (current.ships[ship]||0) + qty;
        }
      }
      if(current) attackers.push(current);

      for(const a of attackers){
        let w=0;
        for(const [ship, qty] of Object.entries(a.ships)){
          const c = SHIP_COST[ship];
          if(typeof c==="number") w += c*qty;
        }
        a.weight = w;
      }

      let df = {m:0,c:0,d:0};
      const dfMatch = t.match(/float\s+([\d\.\,]+)\s*metal,\s*([\d\.\,]+)\s*crystal\s+and\s*([\d\.\,]+)\s*deuterium/i)
                  || t.match(/fluttuano\s+([\d\.\,]+)\s*metallo,\s*([\d\.\,]+)\s*cristallo\s+e\s*([\d\.\,]+)\s*deuterio/i);
      if(dfMatch){
        df = {m: parseIntOgame(dfMatch[1]), c: parseIntOgame(dfMatch[2]), d: parseIntOgame(dfMatch[3])};
      }
      return {attackers, df};
    }

    // --- B) CR in formato "stdClass dump" (rawOut / tool esterni)
    let df = {m:0,c:0,d:0};
    const mDF = t.match(/\[metal_in_debris_field\]\s*=>\s*([0-9\.,]+)/i);
    const cDF = t.match(/\[crystal_in_debris_field\]\s*=>\s*([0-9\.,]+)/i);
    const dDF = t.match(/\[deuterium_in_debris_field\]\s*=>\s*([0-9\.,]+)/i);
    if(mDF||cDF||dDF){
      df = {
        m: parseIntOgame((mDF&&mDF[1])||"0"),
        c: parseIntOgame((cDF&&cDF[1])||"0"),
        d: parseIntOgame((dDF&&dDF[1])||"0")
      };
    }

    // Prova 1: [attackers] ... [name] => X
    const attackersSet = new Set();
    const reAttackersBlock = /\[attackers\][\s\S]*?(?=\n\s*\[[A-Za-z_]+\]\s*=>|$)/ig;
    const blocks = t.match(reAttackersBlock) || [];
    for(const b of blocks){
      const reNameIn = /\[name\]\s*=>\s*([^\n\r]+)/ig;
      let m;
      while((m=reNameIn.exec(b))!==null){
        const nm = (m[1]||"").trim();
        if(nm && nm.length<=40) attackersSet.add(nm);
      }
    }

    // Prova 2: [attacker_name] => X
    if(attackersSet.size===0){
      const reName = /\[(attacker_name)\]\s*=>\s*([^\n\r]+)/ig;
      let mm;
      while((mm = reName.exec(t))!==null){
        const nm = (mm[2]||"").trim();
        if(nm && nm.length<=40) attackersSet.add(nm);
      }
    }

    // Prova 3: testo "Attacker X [TAG]"
    if(attackersSet.size===0){
      const reAlt = /Attacker\s+([^\[\n\r]+)\s*\[/ig;
      let ma;
      while((ma=reAlt.exec(t))!==null) attackersSet.add(ma[1].trim());
    }

    const attackers = Array.from(attackersSet).map(n=>({
      name:n,
      ships:{},
      weight:1,
      collected:{m:0,c:0,d:0},
      share:{m:0,c:0,d:0},
      settle:{m:0,c:0,d:0},
      settleTotal:0
    }));

    if(!attackers.length){
      attackers.push({
        name:"Attaccante",
        ships:{},
        weight:1,
        collected:{m:0,c:0,d:0},
        share:{m:0,c:0,d:0},
        settle:{m:0,c:0,d:0},
        settleTotal:0
      });
    }

    return {attackers, df};
  }

  // ---------- parsing RR ----------
  function extractPlayerFromRR(text){
    const t = String(text||"");
    const m1 = t.match(/^[ \t]*(?:Da|From)\s*:\s*([^\n\r]+)$/im);
    if(m1){
      let cand = m1[1].trim().replace(/\.+$/,"").trim();
      if(cand && !/^flotta$/i.test(cand)) return cand;
    }
    const m3 = t.match(/riciclatrici\s+di\s+([^\n\r]+)$/im);
    if(m3) return m3[1].trim();
    return "";
  }
  function extractCoordsFromText(text){
    const m = String(text||"").match(/(\d+:\d+:\d+)/);
    return m ? m[1] : "";
  }
  function autoAssignByCoords(rrText){
    const coord = extractCoordsFromText(rrText);
    if(!coord) return "";
    // if we had stored crText, try find unique attacker whose name appears near coord is not possible; better: if only one attacker exists, return it
    if(state.attackers.length===1) return state.attackers[0].name;
    return "";
  }

  function parseRR(text, coordFilter){
    const t = String(text||"");

    // stdClass dump (nomoreangel rawOut)
    const hasStd = /\[owner_name\]\s*=>/i.test(t) && /\[metal_retrieved\]\s*=>/i.test(t);
    if(hasStd){
      const items = [];
      const parts = t.split(/\[rr_id\]\s*=>/i).map((p,i)=> i===0 ? p : "[rr_id] =>"+p);
      for(const part of parts){
        if(!/\[metal_retrieved\]\s*=>/i.test(part)) continue;

        const owner = (part.match(/\[owner_name\]\s*=>\s*([^\n\r]+)/i)||[])[1]?.trim() || "";
        const coord  = (part.match(/\[coordinates\]\s*=>\s*([0-9]+:[0-9]+:[0-9]+)/i)||[])[1]?.trim() || "";
        const m = parseIntOgame((part.match(/\[metal_retrieved\]\s*=>\s*([0-9\.,]+)/i)||[])[1]||"0");
        const c = parseIntOgame((part.match(/\[crystal_retrieved\]\s*=>\s*([0-9\.,]+)/i)||[])[1]||"0");
        const d = parseIntOgame((part.match(/\[deuterium_retrieved\]\s*=>\s*([0-9\.,]+)/i)||[])[1]||"0");

        if(coordFilter){
          if(!coord || coord !== coordFilter) continue;
        }
        items.push({coord, m, c, d, owner});
      }
      return items;
    }

    // classic fallback robust
    const blocks = t.split(/\n\s*\n/).map(b=>b.trim()).filter(Boolean);
    const out = [];
    const reCoord = /\[(\d+:\d+:\d+)\]|\b(\d+:\d+:\d+)\b/;

    function toNum(s){ return parseIntOgame(s); }

    for(const b of blocks){
      const coordMatch = b.match(reCoord);
      const coord = coordMatch ? (coordMatch[1]||coordMatch[2]) : "";
      if(coordFilter){
        if(!coord || coord !== coordFilter) continue;
      }
      const lines = b.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      let best = null;

      for(let i=0;i<lines.length-2;i++){
        const a=lines[i], c=lines[i+1], d=lines[i+2];
        const looksTime = (s)=> /(\d{1,2}:\d{2}(:\d{2})?)|--?:--?/.test(s);
        const looksDate = (s)=> /\d{2}\.\d{2}\.\d{4}/.test(s);
        if(looksTime(a)||looksDate(a)||looksTime(c)||looksDate(c)||looksTime(d)||looksDate(d)) continue;
        if(/^[\d\.,]+$/.test(a)&&/^[\d\.,]+$/.test(c)&&/^[\d\.,]+$/.test(d)){
          best = {m:toNum(a), c:toNum(c), d:toNum(d)};
          break;
        }
      }
      if(!best){
        for(const ln of lines){
          if(/\d{2}\.\d{2}\.\d{4}/.test(ln) || /--?:--?/.test(ln)) continue;
          const m = ln.match(/([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)(?!\d)/);
          if(m){ best={m:toNum(m[1]), c:toNum(m[2]), d:toNum(m[3])}; break; }
        }
      }
      if(!best){
        const nums = (b.match(/[\d\.,]+/g)||[]).map(toNum).filter(n=>Number.isFinite(n)&&n>=0);
        let max=-1;
        for(let i=0;i<nums.length-2;i++){
          const s=nums[i]+nums[i+1]+nums[i+2];
          if(s>max){max=s; best={m:nums[i], c:nums[i+1], d:nums[i+2]};}
        }
      }
      if(best) out.push({coord, m:best.m, c:best.c, d:best.d, owner:""});
    }
    return out;
  }

  // ---------- compute ----------
  function rrRecomputeCollected(){
    state.attackers.forEach(a=>{ a.collected={m:0,c:0,d:0}; });
    for(const row of state.rrLog){
      const a = state.attackers.find(x=>x.name===row.player);
      if(!a) continue;
      a.collected.m += row.m;
      a.collected.c += row.c;
      a.collected.d += row.d;
    }
  }

  function computeShares(){
    // apply DF override if set
    const dfM = parseIntOgame($("dfM").value);
    const dfC = parseIntOgame($("dfC").value);
    const dfD = parseIntOgame($("dfD").value);
    const useOverride = (dfM||dfC||dfD) > 0;
    const df = useOverride ? {m:dfM,c:dfC,d:dfD} : state.df;

    const n = state.attackers.length || 1;
    const totalW = state.attackers.reduce((s,a)=>s+(a.weight||0),0);
    const mode = $("mode").value;

    state.attackers.forEach(a=>{
      let ratio = 1/n;
      if(mode==="equa"){
        ratio = totalW>0 ? (a.weight/totalW) : (1/n);
      }
      a.share.m = df.m * ratio;
      a.share.c = df.c * ratio;
      a.share.d = df.d * ratio;

      const colM = a.collected?.m||0, colC=a.collected?.c||0, colD=a.collected?.d||0;
      a.settle.m = a.share.m - colM;
      a.settle.c = a.share.c - colC;
      a.settle.d = a.share.d - colD;
      a.settleTotal = a.settle.m + a.settle.c + a.settle.d;
    });

    state.mode = mode;
    state.collector = $("collector").value || state.collector;

    // KPIs
    $("kAtt").textContent = String(state.attackers.length || 0);
    $("kM").textContent = fmt(df.m,0);
    $("kC").textContent = fmt(df.c,0);
    $("kD").textContent = fmt(df.d,0);

    renderAll();
    saveState();
  }

  // ---------- render ----------
  function ensureRRPlayerOptions(){
    const sel = $("rrPlayer");
    const prev = sel.value;
    sel.innerHTML = "";
    const optAuto = document.createElement("option");
    optAuto.value="__auto__";
    optAuto.textContent="Auto (da RR)";
    sel.appendChild(optAuto);
    state.attackers.forEach(a=>{
      const opt=document.createElement("option");
      opt.value=a.name; opt.textContent=a.name;
      sel.appendChild(opt);
    });
    if(prev && (prev==="__auto__" || state.attackers.some(a=>a.name===prev))) sel.value=prev;
    else sel.value="__auto__";
  }

  function ensureCollectorOptions(){
    const sel = $("collector");
    const prev = sel.value;
    sel.innerHTML = "";
    state.attackers.forEach(a=>{
      const opt=document.createElement("option");
      opt.value=a.name; opt.textContent=a.name;
      sel.appendChild(opt);
    });
    if(prev && state.attackers.some(a=>a.name===prev)) sel.value=prev;
    else if(state.attackers.length) sel.value=state.attackers[0].name;
  }

  function renderRRTable(){
    const tb = $("tbodyRR");
    tb.innerHTML = "";
    if(!state.attackers.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="6">Carica un CR per popolare i giocatori.</td>`;
      tb.appendChild(tr);
      return;
    }
    state.attackers.forEach(a=>{
      const m=a.collected?.m||0, c=a.collected?.c||0, d=a.collected?.d||0;
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(a.name)}</b></td>
        <td class="num">${fmt(m,0)}</td>
        <td class="num">${fmt(c,0)}</td>
        <td class="num">${fmt(d,0)}</td>
        <td class="num">${fmt(m+c+d,0)}</td>
        <td class="num"><button class="ghost smallBtn" data-act="clear" data-player="${escapeHtml(a.name)}">Svuota</button></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("button[data-act='clear']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const p = btn.getAttribute("data-player");
        state.rrLog = state.rrLog.filter(r=>r.player!==p);
        rrRecomputeCollected();
        computeShares();
      });
    });
  }

  function renderResult(){
    const tb = $("tbodyRes");
    tb.innerHTML = "";
    const dec = Number($("decimals").value||2);
    if(!state.attackers.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="7">Carica un CR.</td>`;
      tb.appendChild(tr);
      return;
    }
    state.attackers.forEach(a=>{
      const colTot = (a.collected?.m||0)+(a.collected?.c||0)+(a.collected?.d||0);
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(a.name)}</b></td>
        <td class="num">${fmt(a.weight,0)}</td>
        <td class="num">${fmt(a.share.m,dec)}</td>
        <td class="num">${fmt(a.share.c,dec)}</td>
        <td class="num">${fmt(a.share.d,dec)}</td>
        <td class="num">${fmt(colTot,dec)}</td>
        <td class="num"><span class="${a.settleTotal>=0?'ok':'no'}">${fmt(a.settleTotal,dec)}</span></td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderTransports(){
    const tb = $("tbodyTx");
    tb.innerHTML = "";
    const collector = $("collector").value || (state.attackers[0]?.name||"");
    const capLC = parseIntOgame($("capLC").value) || 25000;
    const capSC = parseIntOgame($("capSC").value) || 50000;
    const strat = $("strategy").value;
    const dec = Number($("decimals").value||2);

    const rec = state.attackers.filter(a=>a.name!==collector && a.settleTotal>0);
    if(!collector || !rec.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="4">Nessuna spedizione necessaria (o raccoglitore non selezionato).</td>`;
      tb.appendChild(tr);
      return;
    }
    for(const a of rec){
      const amount = a.settleTotal;
      const needs = calcTransports(amount, capLC, capSC, strat);
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(collector)}</b> → <b>${escapeHtml(a.name)}</b></td>
        <td class="num">${fmt(amount,dec)}</td>
        <td class="num">${fmt(needs.sc,0)}</td>
        <td class="num">${fmt(needs.lc,0)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function calcTransports(amount, capLC, capSC, strat){
    let rem = Math.max(0, Number(amount||0));
    let lc=0, sc=0;
    const take = (cap)=>{ const k = Math.floor(rem/cap); rem -= k*cap; return k; };

    if(strat==="SC_LC"){
      sc += take(capSC);
      if(rem>0){ sc += 1; rem = 0; }
    }else{
      lc += take(capLC);
      if(rem>0){ lc += 1; rem = 0; }
    }
    return {lc, sc};
  }

  function renderAll(){
    ensureRRPlayerOptions();
    ensureCollectorOptions();
    renderRRTable();
    renderResult();
    renderTransports();
  }

  // ---------- actions ----------
  function setProxyBase(){
    state.proxyBase = $("proxyBase").value.trim() || state.proxyBase;
  }

  $("btnToggleCR").addEventListener("click", ()=>{
    const ta = $("cr");
    ta.style.display = (ta.style.display==="none" ? "block" : "none");
  });
  $("btnToggleRR").addEventListener("click", ()=>{
    const ta = $("rr");
    ta.style.display = (ta.style.display==="none" ? "block" : "none");
  });

  $("proxyBase").addEventListener("input", ()=>{
    setProxyBase();
    saveState();
  });

  $("btnLoadCR").addEventListener("click", async ()=>{
    try{
      setProxyBase();
      const id = $("apiCrId").value.trim();
      if(!id) return;
      const resp = await loadFromApi(id);
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      const txt = resp.text;
      setDebug(`Fetch OK (${resp.status}). URL: ${resp.url}\nPreview: ${txt.slice(0,300).replace(/\s+/g," ").trim()}...`);

      state.crText = txt;
      $("cr").value = txt;
      const parsed = parseCR(txt);
      state.attackers = parsed.attackers;
      state.df = parsed.df;
      state.rrLog = []; // reset RR when CR changes
      rrRecomputeCollected();
      ensureCollectorOptions();
      setDebug(`CR OK: ${state.attackers.length} attaccanti. DF: M ${fmt(state.df.m,0)} C ${fmt(state.df.c,0)} D ${fmt(state.df.d,0)}`);
      computeShares();
    }catch(e){
      setDebug("CR ERR: " + e.message);
      alert("Errore caricamento CR: " + e.message);
    }
  });

  $("btnLoadRR").addEventListener("click", async ()=>{
    try{
      setProxyBase();
      const id = $("apiRrId").value.trim();
      if(!id) return;
      const resp = await loadFromApi(id);
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      const txt = resp.text;
      setDebug(`Fetch OK (${resp.status}). URL: ${resp.url}\nPreview: ${txt.slice(0,300).replace(/\s+/g," ").trim()}...`);

      state.rrText = txt;
      $("rr").value = txt;
      setDebug("RR caricato. Premi “Aggiungi RR” (o lascia Auto).");
      // auto-add when auto
      if($("rrPlayer").value==="__auto__"){
        $("btnAddRR").click();
      }
    }catch(e){
      setDebug("RR ERR: " + e.message);
      alert("Errore caricamento RR: " + e.message);
    }
  });

  $("btnAddRR").addEventListener("click", ()=>{
    const raw = $("rr").value || "";
    if(!raw.trim()) return;

    const coordFilter = ($("rrCoord").value||"").trim();
    let player = $("rrPlayer").value;

    if(player==="__auto__"){
      let guessed = extractPlayerFromRR(raw);
      if(!guessed) guessed = autoAssignByCoords(raw);
      if(guessed) player = guessed;
    }

    const rows = parseRR(raw, coordFilter);
    if(!rows.length){
      alert("Nessun RR valido trovato. Controlla API ID / filtro coordinate.");
      return;
    }

    for(const r of rows){
      const finalPlayer = (player && player!=="__auto__") ? player : (r.owner || "");
      if(!finalPlayer){
        alert('RR caricato, ma manca owner_name. Seleziona manualmente il giocatore e premi "Aggiungi RR".');
        return;
      }
      // ensure in roster
      if(!state.attackers.some(a=>a.name===finalPlayer)){
        state.attackers.push({
          name: finalPlayer, ships:{}, weight:0,
          collected:{m:0,c:0,d:0}, share:{m:0,c:0,d:0},
          settle:{m:0,c:0,d:0}, settleTotal:0
        });
      }
      state.rrLog.push({player: finalPlayer, coord:r.coord||"", m:r.m||0, c:r.c||0, d:r.d||0});
    }

    rrRecomputeCollected();
    computeShares();
    setDebug(`RR aggiunto: ${rows.length} record.`);
  });

  $("btnClearRR").addEventListener("click", ()=>{
    state.rrLog = [];
    rrRecomputeCollected();
    computeShares();
  });

  $("mode").addEventListener("change", computeShares);
  $("collector").addEventListener("change", computeShares);
  $("decimals").addEventListener("change", computeShares);
  $("capLC").addEventListener("input", computeShares);
  $("capSC").addEventListener("input", computeShares);
  $("strategy").addEventListener("change", computeShares);
  $("dfM").addEventListener("input", computeShares);
  $("dfC").addEventListener("input", computeShares);
  $("dfD").addEventListener("input", computeShares);

  $("btnExample").addEventListener("click", ()=>{
    // minimal example: just set api ids user provided
    $("apiCrId").value = "cr-it-269-99ac041223643141081dcf46c909523a0684d4b0";
    $("apiRrId").value = "rr-it-269-0c420ad76f0bed6e54c8efa2d9ef17e4e953df69";
    setDebug("Inseriti esempi di API ID. Premi “Carica CR” poi “Carica RR”.");
  });

  $("btnCopy").addEventListener("click", async ()=>{
    const dec = Number($("decimals").value||2);
    const lines = [];
    lines.push("Spartizione Detriti — ACS");
    lines.push(`Modalità: ${$("mode").value}`);
    lines.push(`DF: M ${fmt(state.df.m,0)} C ${fmt(state.df.c,0)} D ${fmt(state.df.d,0)}`);
    lines.push("");
    for(const a of state.attackers){
      const colTot = (a.collected?.m||0)+(a.collected?.c||0)+(a.collected?.d||0);
      lines.push(`${a.name}: quota ${fmt(a.share.m+a.share.c+a.share.d,dec)} | raccolto ${fmt(colTot,dec)} | da regolare ${fmt(a.settleTotal,dec)}`);
    }
    const txt = lines.join("\n");
    try{ await navigator.clipboard.writeText(txt); setDebug("Riepilogo copiato."); }
    catch(e){ alert("Clipboard non disponibile. Copia manualmente dal debug."); setDebug(txt); }
  });

  $("btnExport").addEventListener("click", ()=>{
    const payload = {
      v:1,
      proxyBase: $("proxyBase").value.trim() || state.proxyBase,
      df: state.df,
      mode: $("mode").value,
      collector: $("collector").value,
      rrLog: state.rrLog,
      attackers: state.attackers.map(a=>({name:a.name, weight:a.weight, ships:a.ships}))
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "spartizione_detriti.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("btnImport").addEventListener("click", ()=> $("fileImport").click());
  $("fileImport").addEventListener("change", async ()=>{
    const f = $("fileImport").files?.[0];
    if(!f) return;
    const txt = await f.text();
    try{
      const p = JSON.parse(txt);
      if(p.proxyBase) {$("proxyBase").value = p.proxyBase; state.proxyBase=p.proxyBase;}
      if(p.df) state.df=p.df;
      if(p.mode) $("mode").value = p.mode;
      if(p.collector) state.collector=p.collector;
      if(Array.isArray(p.attackers)){
        state.attackers = p.attackers.map(x=>({
          name:x.name, ships:x.ships||{}, weight:x.weight||0,
          collected:{m:0,c:0,d:0}, share:{m:0,c:0,d:0},
          settle:{m:0,c:0,d:0}, settleTotal:0
        }));
      }
      if(Array.isArray(p.rrLog)) state.rrLog = p.rrLog;
      rrRecomputeCollected();
      ensureCollectorOptions();
      computeShares();
      setDebug("Import OK.");
    }catch(e){
      alert("JSON non valido.");
    }
  });

  
  $("btnTestCR").addEventListener("click", async ()=>{
    try{
      setProxyBase();
      const id = $("apiCrId").value.trim();
      if(!id) return;
      const resp = await loadFromApi(id);
      setDebug(`CR TEST status=${resp.status} ok=${resp.ok}\nURL: ${resp.url}\n--- preview ---\n${resp.text.slice(0,1200)}`);
    }catch(e){
      setDebug("CR TEST ERR: " + e.message);
    }
  });

  $("btnTestRR").addEventListener("click", async ()=>{
    try{
      setProxyBase();
      const id = $("apiRrId").value.trim();
      if(!id) return;
      const resp = await loadFromApi(id);
      setDebug(`RR TEST status=${resp.status} ok=${resp.ok}\nURL: ${resp.url}\n--- preview ---\n${resp.text.slice(0,1200)}`);
    }catch(e){
      setDebug("RR TEST ERR: " + e.message);
    }
  });


  // ---------- init ----------
  loadState();
  $("proxyBase").value = state.proxyBase;
  $("mode").value = state.mode;
  applyPanelOrder();
  setupDragAndDrop();

  // restore rrLog roster if needed
  // (attackers list will be filled by CR; rrLog alone is not enough to compute shares)
  renderAll();
  setDebug("Pronto. Carica un CR via API.");
})();
</script>
</body>
</html>
