<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OGame — Spartizione Detriti (ACS)</title>
  <style>
    :root{
      --bg:#0b1420;
      --panel:#0f1d2e;
      --panel2:#0c1827;
      --line:#2a3b52;
      --text:#d7e2f0;
      --muted:#9fb1c7;
      --accent:#ffd36a;
      --good:#78f0b0;
      --bad:#ff8b8b;
      --chip:#14263b;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:
        radial-gradient(900px 500px at 20% -10%, rgba(255,211,106,.12), transparent 60%),
        radial-gradient(700px 450px at 90% 0%, rgba(120,240,176,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), #070d16 75%);
      min-height:100vh;
    }
    header{
      max-width:1100px; margin:24px auto 10px; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:36px; height:36px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,211,106,.25), rgba(255,211,106,.06));
      border:1px solid rgba(255,211,106,.35);
      box-shadow: var(--shadow);
      position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:8px;
      border-radius:8px;
      border:1px dashed rgba(255,211,106,.55);
      opacity:.7;
    }
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{margin:0; color:var(--muted); font-size:12px}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button, select, input, textarea{
      font: inherit;
    }
    button{
      background: linear-gradient(180deg, rgba(255,211,106,.18), rgba(255,211,106,.07));
      border:1px solid rgba(255,211,106,.35);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,.22);
    }
    button:hover{filter:brightness(1.06)}
    button:active{transform:translateY(1px)}
    .container{max-width:1100px; margin:0 auto; padding:0 16px 40px;}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.15fr .85fr;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    details{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      background: linear-gradient(180deg, rgba(15,29,46,.88), rgba(12,24,39,.85));
      border-bottom:1px solid rgba(42,59,82,.6);
    }
    summary::-webkit-details-marker{display:none}
    .sum-title{display:flex; align-items:center; gap:10px; font-weight:650}
    .pill{
      font-size:12px; color:var(--muted);
      background:rgba(20,38,59,.8);
      border:1px solid rgba(42,59,82,.7);
      padding:2px 8px; border-radius:999px;
    }
    .chev{
      width:10px; height:10px; border-right:2px solid var(--muted); border-bottom:2px solid var(--muted);
      transform: rotate(-45deg);
      transition: .2s transform ease;
      margin-left:auto;
    }
    details[open] .chev{transform: rotate(45deg)}
    .content{padding:12px 14px; background: rgba(12,24,39,.72)}
    textarea{
      width:100%; min-height:260px;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(42,59,82,.85);
      background: rgba(7,13,22,.65);
      color:var(--text);
      outline:none;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.35;
    }
    textarea:focus, input:focus, select:focus{border-color: rgba(255,211,106,.55); box-shadow: 0 0 0 3px rgba(255,211,106,.10)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    .field{
      min-width:180px;
      flex:1 1 180px;
    }
    input, select{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(42,59,82,.85);
      background: rgba(7,13,22,.55);
      color:var(--text);
    }
    .note{
      font-size:12px; color:var(--muted); margin:10px 0 0;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid rgba(42,59,82,.85);
      background: rgba(7,13,22,.35);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(42,59,82,.55);
      font-size:12px;
      vertical-align:middle;
    }
    th{
      text-align:left;
      color: var(--muted);
      background: rgba(15,29,46,.65);
      position:sticky; top:0;
    }
    tr:last-child td{border-bottom:none}
    .num{font-variant-numeric: tabular-nums; font-family: var(--mono); text-align:right}
    .name{font-weight:650}
    .muted{color:var(--muted)}
    .ok{color:var(--good)}
    .no{color:var(--bad)}
    .split{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px;
    }
    @media (max-width: 680px){ .split{grid-template-columns:1fr} }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0;
    }
    .card{
      flex:1 1 170px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(42,59,82,.85);
      background: rgba(7,13,22,.35);
    }
    .card .t{font-size:11px; color:var(--muted)}
    .card .v{font-family:var(--mono); font-size:13px; margin-top:4px}
    .small{font-size:11px}
    .right{margin-left:auto}
    .footer{
      margin-top:12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .ghost{
      background: transparent;
      border:1px solid rgba(42,59,82,.85);
    }
    .warn{
      border-color: rgba(255,139,139,.45) !important;
      box-shadow: 0 0 0 3px rgba(255,139,139,.10) !important;
    }
    .chipline{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .chip{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(42,59,82,.8);
      background: rgba(20,38,59,.7);
      color: var(--text);
    }
  
    .drag-handle{
      width:14px; height:14px;
      border-radius:6px;
      border:1px solid rgba(42,59,82,.8);
      background: rgba(20,38,59,.7);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:grab;
      flex:0 0 auto;
    }
    .drag-handle:before{
      content:"⋮⋮";
      font-size:10px;
      line-height:1;
      color: var(--muted);
      letter-spacing:-2px;
      transform: rotate(90deg);
    }
    .dragging{
      opacity:.55;
      outline:2px dashed rgba(255,211,106,.35);
      outline-offset:-6px;
    }

  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Spartizione Detriti — ACS</h1>
      <p class="sub">Leggi il CR, calcola quote (paritaria / equa) e i trasporti finali.</p>
    </div>
  </div>
  <div class="toolbar">
    <button id="btnParse">Leggi CR</button>
    <button class="ghost" id="btnExample">Incolla esempio</button>
    <button class="ghost" id="btnExport">Esporta JSON</button>
    <button class="ghost" id="btnImport">Importa JSON</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div>
      <details open data-panel-id="cr">
        <summary>
          <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> 1) CR / Combat Report <span class="pill">input</span></div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          
<div class="row">
  <div class="field">
    <label>API ID (CR)</label>
    <input id="apiCrId" placeholder="es. 123456" />
  </div>
  <div class="field" style="flex:0 0 auto; min-width:auto;">
    <label>&nbsp;</label>
    <button id="btnLoadCR">Carica CR da API</button>
  </div>
</div>
<iframe id="apiCrFrame" style="margin-top:10px; width:100%; height:260px; border:1px solid rgba(42,59,82,.85); border-radius:12px; background:#000;"
  src="" loading="lazy"></iframe>
<textarea id="cr" style="display:none;"></textarea>

          <p class="note">Suggerimento: incolla il CR completo. Il tool legge automaticamente gli attaccanti e i detriti (DF). Se il DF non viene trovato, puoi inserirlo manualmente a destra.</p>
        </div>
      </details>

      <details open style="margin-top:14px;" data-panel-id="rr">
        <summary>
          <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> 1b) RR / Raccolta Riciclatrici <span class="pill">input</span></div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Assegna RR (Auto o manuale)</label>
              <select id="rrPlayer"></select>
            </div>
            <div class="field">
              <label>Coordinate (opzionale, filtro)</label>
              <input id="rrCoord" placeholder="es. 2:181:8" />
            </div>
            <div class="field" style="flex:0 0 auto; min-width:auto;">
              <label>&nbsp;</label>
              <button id="btnAddRR">Aggiungi RR</button>
            </div>
          </div>

          
<div class="row">
  <div class="field">
    <label>API ID (RR)</label>
    <input id="apiRrId" placeholder="es. 654321" />
  </div>
  <div class="field" style="flex:0 0 auto; min-width:auto;">
    <label>&nbsp;</label>
    <button id="btnLoadRR">Carica RR da API</button>
  </div>
</div>
<iframe id="apiRrFrame" style="margin-top:10px; width:100%; height:200px; border:1px solid rgba(42,59,82,.85); border-radius:12px; background:#000;"
  src="" loading="lazy"></iframe>
<textarea id="rr" style="display:none;"></textarea>


          <div class="note">Il tool somma automaticamente la raccolta per giocatore. Formato supportato (IT/EN): righe con coordinate e tre numeri finali (M / C / D). Se il report contiene più RR, puoi incollarli insieme.</div>

          <div style="margin-top:10px; overflow:auto; max-height:220px;">
            <table>
              <thead>
                <tr>
                  <th>Giocatore</th>
                  <th class="num">Raccolto M</th>
                  <th class="num">Raccolto C</th>
                  <th class="num">Raccolto D</th>
                  <th class="num">Totale</th>
                  <th class="num">Azioni</th>
                </tr>
              </thead>
              <tbody id="tbodyRR"></tbody>
            </table>
          </div>

          <div class="footer">
            <button class="ghost" id="btnClearRR">Reset raccolte</button>
            <span class="note small">La raccolta RR viene usata per calcolare “Da regolare”.</span>
          </div>
        </div>
      </details>

      <details open style="margin-top:14px;" data-panel-id="result">
        <summary>
          <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> 3) Risultato spartizione <span class="pill">output</span></div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="kpi">
            <div class="card">
              <div class="t">Modalità</div>
              <div class="v" id="kpiMode">—</div>
            </div>
            <div class="card">
              <div class="t">DF (M / C / D)</div>
              <div class="v" id="kpiDF">—</div>
            </div>
            <div class="card">
              <div class="t">Partecipanti</div>
              <div class="v" id="kpiN">—</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto; max-height:420px;">
            <table>
              <thead>
                <tr>
                  <th>Giocatore</th>
                  <th class="num">Peso</th>
                  <th class="num">Quota M</th>
                  <th class="num">Quota C</th>
                  <th class="num">Quota D</th>
                  <th class="num">Totale</th>
                  <th class="num">Già raccolto (RR/Manuale)</th>
                  <th class="num">Da regolare</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="footer">
            <button id="btnCopy">Copia riepilogo</button>
            <span class="note small">“Da regolare” &gt; 0 = deve ricevere | &lt; 0 = deve dare.</span>
          </div>
        </div>
      </details>
    </div>

    <div>
      <details open data-panel-id="settings">
        <summary>
          <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> 2) Impostazioni <span class="pill">split</span></div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="split">
            <div>
              <div class="row">
                <div class="field">
                  <label>Modalità spartizione</label>
                  <select id="mode">
                    <option value="paritaria">Paritaria (uguale per tutti)</option>
                    <option value="equa">Equa (peso flotta in campo)</option>
                  </select>
                </div>
                <div class="field">
                  <label>Decimali</label>
                  <select id="decimals">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label>DF Metallo</label>
                  <input id="dfM" inputmode="numeric" placeholder="es. 8.451.301.052" />
                </div>
                <div class="field">
                  <label>DF Cristallo</label>
                  <input id="dfC" inputmode="numeric" placeholder="es. 6.135.502.953" />
                </div>
                <div class="field">
                  <label>DF Deuterio</label>
                  <input id="dfD" inputmode="numeric" placeholder="es. 1.725.266.027" />
                </div>
              </div>

              <div class="note">Equa = quota proporzionale al <b>valore flotta in campo</b> (dal CR, prima della sezione “Dopo la battaglia…”).</div>
            </div>

            <div>
              <div class="row">
                <div class="field">
                  <label>Raccoglitore (chi ricicla e poi spedisce)</label>
                  <select id="collector"></select>
                </div>
                <div class="field">
                  <label>Capienza Cargo Pesante</label>
                  <input id="capLC" inputmode="numeric" value="25000" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label>Capienza Cargo Leggero</label>
                  <input id="capSC" inputmode="numeric" value="5000" />
                </div>
                <div class="field">
                  <label>Strategia trasporto</label>
                  <select id="transportMode">
                    <option value="lc-first" selected>Prima Cargo Pesanti</option>
                    <option value="sc-only">Solo Cargo Leggeri</option>
                    <option value="lc-only">Solo Cargo Pesanti</option>
                  </select>
                </div>
              </div>

              <div class="note">Trasporti calcolati sul <b>totale risorse</b> da regolare (M+C+D). Se vuoi spedire separatamente, fai 3 spedizioni (M, C, D) e usa le quote singole.</div>
            </div>
          </div>

          <details style="margin-top:12px;">
            <summary>
              <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> Costi navi (per il “peso”) <span class="pill">editabile</span></div>
              <div class="chev" aria-hidden="true"></div>
            </summary>
            <div class="content">
              <div class="note">Valori standard OGame (M/C/D). Modifica se giochi con setting diversi.</div>
              <div id="costChips" class="chipline"></div>
            </div>
          </details>
        </div>
      </details>

      

      <details open style="margin-top:14px;" data-panel-id="transports">
        <summary>
          <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> 4) Trasporti finali <span class="pill">logistica</span></div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div class="note">Spedizioni dal raccoglitore ai giocatori con “Da regolare” &gt; 0.</div>
          <div style="margin-top:10px; overflow:auto; max-height:420px;">
            <table>
              <thead>
                <tr>
                  <th>Da → A</th>
                  <th class="num">Risorse</th>
                  <th class="num">Cargo Pesanti</th>
                  <th class="num">Cargo Leggeri</th>
                </tr>
              </thead>
              <tbody id="tbodyTrans"></tbody>
            </table>
          </div>
          <div class="note small" style="margin-top:10px;" id="transHint">—</div>
        </div>
      </details>

      <details style="margin-top:14px;" data-panel-id="debug">
        <summary>
          <div class="sum-title"><span class="drag-handle" title="Trascina per riordinare"></span> Note parsing <span class="pill">debug</span></div>
          <div class="chev" aria-hidden="true"></div>
        </summary>
        <div class="content">
          <div id="debug" class="note" style="white-space:pre-wrap;"></div>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
(function(){
  // --- Helpers
  // --- Drag & drop riordino pannelli (salvato in localStorage)
  const PANEL_STORE_KEY = "ogame_spartizione_panel_order_v1";

  function getPanelOrder(){
    try{
      const raw = localStorage.getItem(PANEL_STORE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return (obj && typeof obj==="object") ? obj : null;
    }catch(e){ return null; }
  }
  function savePanelOrder(){
    const cols = document.querySelectorAll(".grid > div");
    const data = {};
    cols.forEach((col, idx)=>{
      const ids = Array.from(col.querySelectorAll("details[data-panel-id]")).map(d=>d.getAttribute("data-panel-id"));
      data["col"+idx] = ids;
    });
    localStorage.setItem(PANEL_STORE_KEY, JSON.stringify(data));
  }
  function applyPanelOrder(){
    const order = getPanelOrder();
    if(!order) return;
    const cols = document.querySelectorAll(".grid > div");
    cols.forEach((col, idx)=>{
      const key = "col"+idx;
      const ids = order[key];
      if(!Array.isArray(ids)) return;
      const map = new Map();
      Array.from(col.querySelectorAll("details[data-panel-id]")).forEach(d=>{
        map.set(d.getAttribute("data-panel-id"), d);
      });
      // rebuild in stored order + any missing at end
      ids.forEach(id=>{
        const el = map.get(id);
        if(el) col.appendChild(el);
      });
      map.forEach((el,id)=>{
        if(!ids.includes(id)) col.appendChild(el);
      });
    });
  }

  function setupDragAndDrop(){
    const cols = document.querySelectorAll(".grid > div");
    let dragEl = null;

    cols.forEach(col=>{
      col.querySelectorAll("details[data-panel-id] > summary").forEach(sum=>{
        // allow dragging by handle only
        const handle = sum.querySelector(".drag-handle");
        if(!handle) return;

        handle.setAttribute("draggable","true");

        handle.addEventListener("dragstart", (ev)=>{
          dragEl = sum.parentElement; // details
          dragEl.classList.add("dragging");
          ev.dataTransfer.effectAllowed = "move";
          ev.dataTransfer.setData("text/plain", dragEl.getAttribute("data-panel-id") || "");
        });

        handle.addEventListener("dragend", ()=>{
          if(dragEl) dragEl.classList.remove("dragging");
          dragEl = null;
          savePanelOrder();
        });
      });

      col.addEventListener("dragover", (ev)=>{
        if(!dragEl) return;
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";

        const after = getDragAfterElement(col, ev.clientY);
        if(after == null){
          col.appendChild(dragEl);
        }else{
          col.insertBefore(dragEl, after);
        }
      });

      col.addEventListener("drop", (ev)=>{
        if(!dragEl) return;
        ev.preventDefault();
        savePanelOrder();
      });
    });

    function getDragAfterElement(container, y){
      const draggables = [...container.querySelectorAll("details[data-panel-id]:not(.dragging)")];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
      for(const child of draggables){
        const box = child.getBoundingClientRect();
        const offset = y - (box.top + box.height/2);
        if(offset < 0 && offset > closest.offset){
          closest = { offset, element: child };
        }
      }
      return closest.element;
    }
  }

  const $ = (id)=>document.getElementById(id);

  function parseIntOgame(x){
    if(x==null) return 0;
    const s = String(x).trim()
      .replace(/\s/g,'')
      .replace(/\./g,'')
      .replace(/,/g,''); // just in case
    const n = Number(s);
    return Number.isFinite(n) ? Math.trunc(n) : 0;
  }
  function fmt(n, dec=0){
    if(!Number.isFinite(n)) return "—";
    const opts = { minimumFractionDigits: dec, maximumFractionDigits: dec };
    return n.toLocaleString('it-IT', opts);
  }
  function clampNonNeg(n){ return n<0?0:n; }

  // --- Ship costs (M/C/D). Editable in one place.
  const COSTS = {
    "Cargo leggero": {m:2000, c:2000, d:0},
    "Cargo pesante": {m:6000, c:6000, d:0},
    "Caccia leggero": {m:3000, c:1000, d:0},
    "Caccia pesante": {m:6000, c:4000, d:0},
    "Incrociatore":  {m:20000, c:7000, d:2000},
    "Nave da battaglia": {m:45000, c:15000, d:0},
    "Bombardiere": {m:50000, c:25000, d:15000},
    "Corazzata": {m:60000, c:50000, d:15000},      // Destroyer
    "Incrociatore da Battaglia": {m:30000, c:40000, d:15000}, // Battlecruiser
    "Reaper": {m:85000, c:55000, d:20000},
    "Pathfinder": {m:8000, c:15000, d:8000},
    // optional / not used for weight by default:
    "Riciclatrice": {m:10000, c:6000, d:2000},
    "Sonda spia": {m:0, c:1000, d:0},
    "Colonizzatrice": {m:10000, c:20000, d:10000},
    "Satellite Solare": {m:0, c:2000, d:500}
  };

  // CR ship labels → canonical keys above
  const SHIP_ALIASES = new Map([
    ["Cargo leggero","Cargo leggero"],
    ["Cargo. L","Cargo leggero"],
    ["Cargo pesante","Cargo pesante"],
    ["Cargo Pesante","Cargo pesante"],
    ["Cargo. P","Cargo pesante"],
    ["Caccia Leggero","Caccia leggero"],
    ["Caccia. L","Caccia leggero"],
    ["Caccia Pesante","Caccia pesante"],
    ["Caccia. P","Caccia pesante"],
    ["Incrociatore","Incrociatore"],
    ["Incrociatori","Incrociatore"],
    ["Nave da battaglia","Nave da battaglia"],
    ["BS","Nave da battaglia"],
    ["Bombardiere","Bombardiere"],
    ["Bombardieri","Bombardiere"],
    ["Corazzata","Corazzata"],
    ["Corazzate","Corazzata"],
    ["Incrociatore da Battaglia","Incrociatore da Battaglia"],
    ["BC","Incrociatore da Battaglia"],
    ["Reaper","Reaper"],
    ["Pathfinder","Pathfinder"],
    ["Riciclatrice","Riciclatrice"],
    ["Riciclatrici","Riciclatrice"],
    ["Sonda spia","Sonda spia"],
    ["Sonde Spia","Sonda spia"],
    ["Colonizzatrice","Colonizzatrice"],
    ["Colonizzatrici","Colonizzatrice"],
    ["Satellite Solare","Satellite Solare"],
    ["Satelliti","Satellite Solare"],
  ]);

  function canonShipLabel(raw){
    const s = String(raw).trim();
    return SHIP_ALIASES.get(s) || s; // fall back
  }

  function shipValue(shipKey, count){
    const cost = COSTS[shipKey];
    if(!cost) return 0;
    return count * (cost.m + cost.c + cost.d);
  }

  function renderCostChips(){
    const wrap = $("costChips");
    wrap.innerHTML = "";
    Object.keys(COSTS).forEach(k=>{
      const v = COSTS[k];
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = `${k}: ${fmt(v.m)}/${fmt(v.c)}/${fmt(v.d)}`;
      wrap.appendChild(chip);
    });
  }

  // --- State
  let state = {
    attackers: [], // {name, ships, weight, collected:{m,c,d}, share:{m,c,d}, settle:{m,c,d}, settleTotal}
    df: {m:0,c:0,d:0},
    mode: "paritaria",
    rrLog: [] // {player, coord, m,c,d, rawCount}
  };

  function parseCR(text){
    const lines = text.split(/\r?\n/);
    const attackers = [];
    let current = null;
    let inInitial = true;

    const debug = [];
    function pushDebug(s){ debug.push(s); }

    // DF regex (English + Italian variants)
    const reDF_en = /float\s+([\d\.,]+)\s+metal,\s+([\d\.,]+)\s+crystal\s+and\s+([\d\.,]+)\s+deuterium/i;
    const reDF_it1 = /fluttuano\s+([\d\.,]+)\s+metallo,\s+([\d\.,]+)\s+cristallo\s+e\s+([\d\.,]+)\s+deuterio/i;
    const reDF_it2 = /ora.*?([\d\.,]+)\s+metallo,\s+([\d\.,]+)\s+cristallo\s+e\s+([\d\.,]+)\s+deuterio/i;

    let dfFound = null;

    for(let i=0;i<lines.length;i++){
      const raw = lines[i];
      const line = raw.trim();

      if(!line) continue;

      if(line.toLowerCase().includes("dopo la battaglia")){
        inInitial = false;
        if(current){ attackers.push(current); current=null; }
        pushDebug("Trovata sezione: Dopo la battaglia → stop lettura flotta in campo.");
        continue;
      }

      // attackers only in initial section
      if(inInitial){
        const mAtt = line.match(/^Attaccante\s+(.+?)(\s+\[|$)/i);
        if(mAtt){
          if(current) attackers.push(current);
          const name = mAtt[1].trim();
          current = { name, ships:{}, weight:0, collected:{m:0,c:0,d:0}, share:{m:0,c:0,d:0}, settle:{m:0,c:0,d:0}, settleTotal:0 };
          pushDebug(`Attaccante trovato: ${name}`);
          continue;
        }

        // ship line "Caccia Leggero 3.226.909" or "Cargo Pesante 1"
        const mShip = line.match(/^([A-Za-zÀ-ÿ .]+?)\s+([\d\.,]+)(?:\s*\(|$)/);
        if(mShip && current){
          const labelRaw = mShip[1].trim().replace(/\.+$/,'');
          const cnt = parseIntOgame(mShip[2]);
          const key = canonShipLabel(labelRaw);
          // only count if we have a known ship cost (for weight)
          current.ships[key] = (current.ships[key]||0) + cnt;
          continue;
        }
      }

      // DF anywhere
      if(!dfFound){
        let m = line.match(reDF_en) || line.match(reDF_it1) || line.match(reDF_it2);
        if(m){
          dfFound = { m: parseIntOgame(m[1]), c: parseIntOgame(m[2]), d: parseIntOgame(m[3]) };
          pushDebug(`DF trovato: M=${dfFound.m} C=${dfFound.c} D=${dfFound.d}`);
        }
      }
    }
    if(current) attackers.push(current);

    // compute weights
    attackers.forEach(a=>{
      let w=0;
      for(const [shipKey, count] of Object.entries(a.ships)){
        w += shipValue(shipKey, count);
      }
      a.weight = w;
    });

    return { attackers, df: dfFound || null, debug: debug.join("\n") };
  }

  function ensureCollectorOptions(){
    const sel = $("collector");
    const prev = sel.value;
    sel.innerHTML = "";
    state.attackers.forEach(a=>{
      const opt = document.createElement("option");
      opt.value = a.name;
      opt.textContent = a.name;
      sel.appendChild(opt);
    });
    if(prev && (prev==="__auto__" || state.attackers.some(a=>a.name===prev))) sel.value = prev;
    else sel.value = "__auto__";
  }

  function computeShares(){
    const dec = Number($("decimals").value);
    const mode = $("mode").value;
    state.mode = mode;

    // DF from inputs
    const df = {
      m: parseIntOgame($("dfM").value),
      c: parseIntOgame($("dfC").value),
      d: parseIntOgame($("dfD").value),
    };
    state.df = df;

    const n = state.attackers.length;
    if(n===0) return;

    // weights
    let weights = state.attackers.map(a=>a.weight);
    const totalW = weights.reduce((s,x)=>s+x,0);

    state.attackers.forEach((a, idx)=>{
      let ratio = 1/n;
      if(mode==="equa"){
        ratio = totalW>0 ? (a.weight/totalW) : (1/n);
      }
      a.share.m = df.m * ratio;
      a.share.c = df.c * ratio;
      a.share.d = df.d * ratio;

      // collected & settlement (per resource)
      const colM = a.collected?.m || 0;
      const colC = a.collected?.c || 0;
      const colD = a.collected?.d || 0;

      a.settle.m = a.share.m - colM;
      a.settle.c = a.share.c - colC;
      a.settle.d = a.share.d - colD;
      a.settleTotal = (a.settle.m + a.settle.c + a.settle.d);
    });

    renderTable(dec);
    renderTransports(dec);

    // KPIs
    $("kpiMode").textContent = mode==="paritaria" ? "Paritaria" : "Equa (peso flotta)";
    $("kpiDF").textContent = `${fmt(df.m)} / ${fmt(df.c)} / ${fmt(df.d)}`;
    $("kpiN").textContent = String(n);
  }

  function renderTable(dec){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    for(const a of state.attackers){
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.innerHTML = `<div class="name">${escapeHtml(a.name)}</div><div class="muted small">${Object.keys(a.ships).length ? "flotta letta" : "—"}</div>`;
      tr.appendChild(tdName);

      const tdW = document.createElement("td");
      tdW.className="num";
      tdW.textContent = a.weight ? fmt(a.weight,0) : "—";
      tr.appendChild(tdW);

      const tdM = document.createElement("td");
      tdM.className="num";
      tdM.textContent = fmt(a.share.m, dec);
      tr.appendChild(tdM);

      const tdC = document.createElement("td");
      tdC.className="num";
      tdC.textContent = fmt(a.share.c, dec);
      tr.appendChild(tdC);

      const tdD = document.createElement("td");
      tdD.className="num";
      tdD.textContent = fmt(a.share.d, dec);
      tr.appendChild(tdD);

      const tdTot = document.createElement("td");
      tdTot.className="num";
      tdTot.textContent = fmt(a.share.m+a.share.c+a.share.d, dec);
      tr.appendChild(tdTot);

      const tdColl = document.createElement("td");
      tdColl.className="num";
      const inp = document.createElement("input");
      const colTot = (a.collected?.m||0) + (a.collected?.c||0) + (a.collected?.d||0);
      inp.value = colTot ? String(Math.trunc(colTot)) : "";
      inp.placeholder = "0";
      inp.inputMode = "numeric";
      inp.style.textAlign="right";
      inp.title = "Totale raccolto (RR + eventuale manuale). Se inserisci un totale, verrà ripartito su M/C/D in proporzione alle quote.";
      inp.addEventListener("input", ()=>{
        const tot = parseIntOgame(inp.value);
        a.collectedManualTotal = tot;
        // riparto proporzionale alla quota (se disponibile)
        const shTot = (a.share.m+a.share.c+a.share.d) || 0;
        if(shTot>0){
          a.collected.m = tot * (a.share.m/shTot);
          a.collected.c = tot * (a.share.c/shTot);
          a.collected.d = tot * (a.share.d/shTot);
        }else{
          a.collected.m = tot; a.collected.c = 0; a.collected.d = 0;
        }
        computeShares();
      });
      tdColl.appendChild(inp);
      tr.appendChild(tdColl);

      const tdSet = document.createElement("td");
      tdSet.className="num";
      tdSet.innerHTML = `<span class="${a.settleTotal>=0?'ok':'no'}">${fmt(a.settleTotal, dec)}</span>`;
      tr.appendChild(tdSet);

      tbody.appendChild(tr);
    }
  }

  function renderTransports(dec){
    const tbody = $("tbodyTrans");
    tbody.innerHTML = "";

    const collector = $("collector").value;
    const capLC = Math.max(1, parseIntOgame($("capLC").value) || 25000);
    const capSC = Math.max(1, parseIntOgame($("capSC").value) || 5000);
    const strat = $("transportMode").value;

    let rows = [];
    for(const a of state.attackers){
      if(a.name === collector) continue;
      if(a.settleTotal <= 0) continue; // only those who must receive
      const amount = a.settleTotal;

      let lc=0, sc=0;
      if(strat==="sc-only"){
        sc = Math.ceil(amount / capSC);
      }else if(strat==="lc-only"){
        lc = Math.ceil(amount / capLC);
      }else{
        // lc-first
        lc = Math.floor(amount / capLC);
        const rem = amount - lc*capLC;
        if(rem>0){
          // decide whether add 1 LC or SCs
          const scNeed = Math.ceil(rem / capSC);
          if(capLC <= scNeed*capSC) lc += 1;
          else sc = scNeed;
        }
      }

      rows.push({to:a.name, amount, lc, sc});
    }

    if(rows.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="4">Nessuna spedizione necessaria (o manca il DF / i partecipanti).</td>`;
      tbody.appendChild(tr);
    }else{
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td><span class="name">${escapeHtml(collector||"—")}</span> → <span class="name">${escapeHtml(r.to)}</span></td>
          <td class="num">${fmt(r.amount, dec)}</td>
          <td class="num">${fmt(r.lc,0)}</td>
          <td class="num">${fmt(r.sc,0)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    $("transHint").textContent = `Capienza: LC=${fmt(capLC,0)} | SC=${fmt(capSC,0)} | Strategia: ${strat==="lc-first"?"LC→SC":"solo "+(strat==="lc-only"?"LC":"SC")}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function setDFInputs(df){
    $("dfM").value = df?.m ? fmt(df.m,0).replace(/\./g,'') : (df?.m??"");
    $("dfC").value = df?.c ? fmt(df.c,0).replace(/\./g,'') : (df?.c??"");
    $("dfD").value = df?.d ? fmt(df.d,0).replace(/\./g,'') : (df?.d??"");
    // keep as raw numbers (no thousands separators) for easy editing
    $("dfM").value = df?.m ? String(df.m) : "";
    $("dfC").value = df?.c ? String(df.c) : "";
    $("dfD").value = df?.d ? String(df.d) : "";
  }

  
  // --- RR (Raccolta Riciclatrici)
  function ensureRRPlayerOptions(){
    const sel = $("rrPlayer");
    const prev = sel.value;
    sel.innerHTML = "";
    const autoOpt = document.createElement("option");
    autoOpt.value = "__auto__";
    autoOpt.textContent = "Auto (da RR)";
    sel.appendChild(autoOpt);
    state.attackers.forEach(a=>{
      const opt = document.createElement("option");
      opt.value = a.name;
      opt.textContent = a.name;
      sel.appendChild(opt);
    });
    if(prev && (prev==="__auto__" || state.attackers.some(a=>a.name===prev))) sel.value = prev;
    else sel.value = "__auto__";
  }

  
  function extractPlayerFromRR(text){
  function extractCoordsFromText(text){
    const m = String(text||"").match(/(\d+:\d+:\d+)/);
    return m ? m[1] : "";
  }

  function autoAssignByCoords(rrText){
    const coord = extractCoordsFromText(rrText);
    if(!coord) return "";
    // find attackers whose CR mentions the same coord
    const hits = state.attackers.filter(a=>{
      return (state.crText||"").includes(coord) && a.name;
    });
    if(hits.length===1) return hits[0].name;
    return "";
  }


    const t = String(text||"");
    // Heuristics for common OGame message formats (IT/EN).
    // Try "Da: <player>" / "From: <player>" lines (excluding "Flotta").
    const m1 = t.match(/^[ \t]*(?:Da|From)\s*:\s*([^\n\r]+)$/im);
    if(m1){
      let cand = m1[1].trim();
      // remove trailing dots, timestamps
      cand = cand.replace(/\.+$/,"").trim();
      if(cand && !/^flotta$/i.test(cand)) return cand;
    }
    // Sometimes the player is in subject like "Rapporto raccolta detriti su ... (<player>)"
    const m2 = t.match(/raccolta detriti.*?\(([^)]+)\)/i);
    if(m2){
      const cand = m2[1].trim();
      if(cand) return cand;
    }
    // Sometimes "Riciclatrici di <player>"
    const m3 = t.match(/riciclatrici\s+di\s+([^\n\r]+)$/im);
    if(m3){
      const cand = m3[1].trim();
      if(cand) return cand;
    }
    return "";
  }

function parseRR(text, coordFilter){
    // Supporta blocchi multipli. Estrae coordinate (se presenti) e le risorse raccolte M/C/D in modo robusto.
    const blocks = String(text || "")
      .split(/\n\s*\n/)
      .map(b => b.trim())
      .filter(Boolean);

    const out = [];
    const reCoord = /\[(\d+:\d+:\d+)\]|\b(\d+:\d+:\d+)\b/;

    function toNum(s){ return parseIntOgame(s); }

    for(const b of blocks){
      const coordMatch = b.match(reCoord);
      const coord = coordMatch ? (coordMatch[1] || coordMatch[2]) : "";

      if(coordFilter){
        if(!coord || coord !== coordFilter) continue;
      }

      const lines = b.split(/\r?\n/).map(x => x.trim()).filter(Boolean);

      let best = null;

      // 1) Tripletta su 3 righe consecutive (tipico RR IT: M \n C \n D)
      for(let i=0;i<lines.length-2;i++){
        const a = lines[i], c = lines[i+1], d = lines[i+2];

        const looksLikeTime = (s)=> /(\d{1,2}:\d{2}(:\d{2})?)|--?:--?/.test(s);
        const looksLikeDate = (s)=> /\d{2}\.\d{2}\.\d{4}/.test(s);

        if(looksLikeTime(a) || looksLikeDate(a)) continue;
        if(looksLikeTime(c) || looksLikeDate(c)) continue;
        if(looksLikeTime(d) || looksLikeDate(d)) continue;

        if(/^[\d\.,]+$/.test(a) && /^[\d\.,]+$/.test(c) && /^[\d\.,]+$/.test(d)){
          best = { m: toNum(a), c: toNum(c), d: toNum(d) };
          break;
        }
      }

      // 2) Tripletta sulla stessa riga: "M C D"
      if(!best){
        for(const ln of lines){
          if(/\d{2}\.\d{2}\.\d{4}/.test(ln) || /--?:--?/.test(ln)) continue;
          const m = ln.match(/([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)(?!\d)/);
          if(m){
            best = { m: toNum(m[1]), c: toNum(m[2]), d: toNum(m[3]) };
            break;
          }
        }
      }

      // 3) Fallback: scegli la tripletta numerica con somma più alta
      if(!best){
        const nums = (b.match(/[\d\.,]+/g) || [])
          .map(toNum)
          .filter(n => Number.isFinite(n) && n >= 0);

        let maxSum = -1;
        for(let i=0;i<nums.length-2;i++){
          const s = nums[i] + nums[i+1] + nums[i+2];
          if(s > maxSum){
            maxSum = s;
            best = { m: nums[i], c: nums[i+1], d: nums[i+2] };
          }
        }
      }

      if(best){
        out.push({ coord, m: best.m, c: best.c, d: best.d });
      }
    }
    return out;
  }

  function rrRecomputeCollected(){
    // reset collected to RR sums, then apply any manualTotal by riparto proporzionale (computeShares farà il resto)
    state.attackers.forEach(a=>{
      a.collected = {m:0,c:0,d:0};
    });

    for(const row of state.rrLog){
      const a = state.attackers.find(x=>x.name===row.player);
      if(!a) continue;
      a.collected.m += row.m;
      a.collected.c += row.c;
      a.collected.d += row.d;
    }

    // se ci sono manualTotal, verranno ripartiti al prossimo computeShares quando l'utente modifica input (non li sovrascriviamo qui)
    computeShares();
    renderRRTable();
  }

  function renderRRTable(){
    const tbody = $("tbodyRR");
    tbody.innerHTML = "";
    if(state.attackers.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="6">Prima leggi un CR per popolare la lista dei giocatori.</td>`;
      tbody.appendChild(tr);
      return;
    }

    state.attackers.forEach(a=>{
      const m = a.collected?.m||0, c=a.collected?.c||0, d=a.collected?.d||0;
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><span class="name">${escapeHtml(a.name)}</span></td>
        <td class="num">${fmt(m,0)}</td>
        <td class="num">${fmt(c,0)}</td>
        <td class="num">${fmt(d,0)}</td>
        <td class="num">${fmt(m+c+d,0)}</td>
        <td class="num"><button class="ghost" data-act="clear" data-player="${escapeHtml(a.name)}">Svuota</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-act='clear']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const player = btn.getAttribute("data-player");
        // rimuovi righe rr per quel player
        state.rrLog = state.rrLog.filter(r=>r.player!==player);
        rrRecomputeCollected();
      });
    });
  }

  // --- UI actions
  
  // --- API Reader (nomoreangel.de) — AUTO READ (rawOut=on)
  const API_BASE = "https://nomoreangel.de/api-reader/?rawOut=on&apiid=";

  async function loadFromApi(apiId){
    const url = API_BASE + encodeURIComponent(apiId);
    try{
      const res = await fetch(url);
      if(!res.ok) throw new Error("HTTP "+res.status);
      return await res.text();
    }catch(e){
      throw new Error("Impossibile leggere l'API. Apri il tool via http:// (server locale o hosting).");
    }
  }

  $("btnLoadCR").addEventListener("click", async ()=>{
    const id = $("apiCrId").value.trim();
    if(!id) return;
    try{
      const txt = await loadFromApi(id);
      $("cr").value = txt;
      $("debug").textContent = "CR caricato automaticamente via API.";
      $("btnParse").click();
    }catch(err){
      alert(err.message);
    }
  });

  $("btnLoadRR").addEventListener("click", async ()=>{
    const id = $("apiRrId").value.trim();
    if(!id) return;
    try{
      const txt = await loadFromApi(id);
      $("rr").value = txt;
      $("debug").textContent = "RR caricato automaticamente via API.";
    }catch(err){
      alert(err.message);
    }
  });

  // ---
  $("btnLoadRR").addEventListener
("click", ()=>{
    const id = $("apiRrId").value.trim();
    if(!id) return;
    const url = API_BASE + encodeURIComponent(id);
    $("apiRrFrame").src = url;
    $("debug").textContent = "RR caricato via API reader. Se necessario, copia il testo dal frame.";
  });

  $("btnParse").addEventListener("click", ()=>{
    state.crText = $("cr").value || "";
    const text = $("cr").value || "";
    const {attackers, df, debug} = parseCR(text);

    state.attackers = attackers;
    $("debug").textContent = debug || "—";

    ensureCollectorOptions();
    ensureRRPlayerOptions();
    renderRRTable();

    if(df){
      setDFInputs(df);
    }else{
      $("dfM").classList.add("warn");
      $("dfC").classList.add("warn");
      $("dfD").classList.add("warn");
      setTimeout(()=>{ $("dfM").classList.remove("warn"); $("dfC").classList.remove("warn"); $("dfD").classList.remove("warn"); }, 1200);
    }

    computeShares();
  });

  $("mode").addEventListener("change", computeShares);
  $("decimals").addEventListener("change", computeShares);
  $("dfM").addEventListener("input", computeShares);
  $("dfC").addEventListener("input", computeShares);
  $("dfD").addEventListener("input", computeShares);
  $("collector").addEventListener("change", computeShares);
  $("capLC").addEventListener("input", computeShares);
  $("capSC").addEventListener("input", computeShares);
  $("transportMode").addEventListener("change", computeShares);

  
  $("btnAddRR").addEventListener("click", ()=>{
    let player = $("rrPlayer").value;
    const coordFilter = ($("rrCoord").value || "").trim();
    const raw = $("rr").value || "";
    if(!raw.trim()) return;

    if(player==="__auto__"){
      let guessed = extractPlayerFromRR(raw);
      if(!guessed){
        guessed = autoAssignByCoords(raw);
      }
      if(guessed) player = guessed;
    }

    if(!player || player==="__auto__"){
      alert("Non riesco a riconoscere il nome del giocatore da questo RR. Seleziona manualmente il giocatore e riprova.");
      return;
    }

    const rows = parseRR(raw, coordFilter);
    if(rows.length===0){
      alert("Nessun RR valido trovato. Controlla di aver incollato il report completo e/o le coordinate.");
      return;
    }

    // se il player non è tra gli attaccanti, lo aggiungo (peso=0)
    if(!state.attackers.some(a=>a.name===player)){
      state.attackers.push({ name: player, ships: {}, weight: 0, collected: {m:0,c:0,d:0}, share: {m:0,c:0,d:0}, settle: {m:0,c:0,d:0}, settleTotal: 0 });
      ensureCollectorOptions();
      ensureRRPlayerOptions();
    }

    for(const r of rows){
      state.rrLog.push({player, coord: r.coord, m:r.m, c:r.c, d:r.d, rawCount:1});
    }
    $("rr").value = "";
    rrRecomputeCollected();
  });

  $("btnClearRR").addEventListener("click", ()=>{
    state.rrLog = [];
    rrRecomputeCollected();
  });

$("btnCopy").addEventListener("click", async ()=>{
    const dec = Number($("decimals").value);
    const df = state.df;
    const mode = $("mode").value;
    let out = [];
    out.push(`Spartizione detriti (${mode})`);
    out.push(`DF: M ${fmt(df.m,0)} | C ${fmt(df.c,0)} | D ${fmt(df.d,0)}`);
    out.push("");
    state.attackers.forEach(a=>{
      out.push(`${a.name}: M ${fmt(a.share.m,dec)} | C ${fmt(a.share.c,dec)} | D ${fmt(a.share.d,dec)} | Tot ${fmt(a.share.m+a.share.c+a.share.d,dec)} | Regola ${fmt(a.settleTotal,dec)}`);
    });
    out.push("");
    const collector = $("collector").value;
    out.push(`Trasporti (da ${collector}):`);
    const rows = Array.from($("tbodyTrans").querySelectorAll("tr"));
    if(rows.length){
      rows.forEach(r=>{
        const tds = r.querySelectorAll("td");
        if(tds.length===4){
          out.push(`${tds[0].innerText} | Risorse ${tds[1].innerText} | LC ${tds[2].innerText} | SC ${tds[3].innerText}`);
        }
      });
    }
    const text = out.join("\n");
    try{
      await navigator.clipboard.writeText(text);
      alert("Riepilogo copiato!");
    }catch(e){
      prompt("Copia manualmente:", text);
    }
  });

  $("btnExport").addEventListener("click", ()=>{
    const payload = {
      version: 1,
      mode: $("mode").value,
      decimals: $("decimals").value,
      df: {
        m: parseIntOgame($("dfM").value),
        c: parseIntOgame($("dfC").value),
        d: parseIntOgame($("dfD").value)
      },
      collector: $("collector").value,
      capLC: parseIntOgame($("capLC").value),
      capSC: parseIntOgame($("capSC").value),
      transportMode: $("transportMode").value,
      attackers: state.attackers.map(a=>({
        name:a.name,
        ships:a.ships,
        weight:a.weight,
        collected: a.collected||{m:0,c:0,d:0}
      })),
      cr: $("cr").value || ""
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "spartizione-detriti.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("btnImport").addEventListener("click", async ()=>{
    const inp = document.createElement("input");
    inp.type="file";
    inp.accept="application/json";
    inp.onchange = async ()=>{
      const file = inp.files?.[0];
      if(!file) return;
      const txt = await file.text();
      const data = JSON.parse(txt);

      $("mode").value = data.mode || "paritaria";
      $("decimals").value = data.decimals || "2";
      setDFInputs(data.df || {m:0,c:0,d:0});
      $("capLC").value = data.capLC ?? 25000;
      $("capSC").value = data.capSC ?? 5000;
      $("transportMode").value = data.transportMode || "lc-first";
      $("cr").value = data.cr || "";

      state.attackers = (data.attackers||[]).map(x=>({
        name:x.name, ships:x.ships||{}, weight:x.weight||0, collected:x.collected||{m:0,c:0,d:0},
        share:{m:0,c:0,d:0}, settle:{m:0,c:0,d:0}, settleTotal:0
      }));
      // recompute weights in case
      state.attackers.forEach(a=>{
        let w=0;
        for(const [shipKey,count] of Object.entries(a.ships)){
          w += shipValue(shipKey, count);
        }
        a.weight = w;
      });

      ensureCollectorOptions();
    ensureRRPlayerOptions();
    renderRRTable();
      if(data.collector) $("collector").value = data.collector;

      computeShares();
      $("debug").textContent = "Import completato.";
    };
    inp.click();
  });

  $("btnExample").addEventListener("click", ()=>{
    const ex = `Il 28-01-2026 --:--:--, le seguenti flotte si scontrano in combattimento:\n\n\nAttaccante Abubu [U E]\n________________________________________________\n\nCargo Pesante 1\nCaccia Leggero 3.226.909\nCaccia Pesante 177.230\nIncrociatore 557.550\nNave da battaglia 151.773\nCorazzata 89.802\nIncrociatore da Battaglia 462.085\nReaper 129.700\nPathfinder 96.320\n_________________________________________\n\nAttaccante Pablito [B V]\n________________________________________________\n\nCaccia Leggero 2.052.722\nCaccia Pesante 135.754\nIncrociatore 341.975\nNave da battaglia 94.921\nBombardiere 20.906\nCorazzata 102.324\nIncrociatore da Battaglia 203.647\nReaper 87.875\nPathfinder 59.309\n_________________________________________\n\nAttaccante Germund [B V]\n________________________________________________\n\nCaccia Leggero 1.874.899\nCaccia Pesante 109.021\nIncrociatore 372.466\nNave da battaglia 197.134\nBombardiere 19.351\nCorazzata 51.275\nIncrociatore da Battaglia 254.348\nReaper 117.084\nPathfinder 55.945\n_________________________________________\n\nAttaccante LordB [B V]\n________________________________________________\n\nCaccia Leggero 500.000\nCaccia Pesante 370.000\nIncrociatore 400.000\nNave da battaglia 70.000\nBombardiere 29.000\nCorazzata 19.000\nIncrociatore da Battaglia 400.000\nReaper 52.000\nPathfinder 64.000\n_________________________________________\n\nAttaccante Pippozzy [B V]\n________________________________________________\n\nCaccia Leggero 1.818.333\nCaccia Pesante 170.048\nIncrociatore 424.375\nNave da battaglia 163.425\nIncrociatore da Battaglia 201.525\nReaper 89.106\nPathfinder 85.870\n_________________________________________\n\nAt these space coordinates now float 8.451.301.052 metal, 6.135.502.953 crystal and 1.725.266.027 deuterium.\n`;
    $("cr").value = ex;
  });

  // init
  applyPanelOrder();
  setupDragAndDrop();
  renderCostChips();
  // small default view
  state.attackers = [];
  ensureCollectorOptions();
    ensureRRPlayerOptions();
    renderRRTable();
  computeShares();
})();
</script>
</body>
</html>
