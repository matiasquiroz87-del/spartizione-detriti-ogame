<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Spartizione Detriti OGame</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    background:#0b0f16;
    color:#d8e0ff;
    font-family:Arial,Helvetica,sans-serif;
    margin:0;
}
header{
    background:#121a2b;
    border-bottom:2px solid #1f2a44;
    padding:12px 20px;
}
header h1{
    margin:0;
    font-size:20px;
    color:#8fb1ff;
}
main{ padding:20px; }
textarea,button,input{
    background:#0f172a;
    color:#e5ecff;
    border:1px solid #2a3a5e;
    border-radius:4px;
    padding:8px;
    font-size:14px;
}
textarea{ width:100%; min-height:260px; resize:vertical; }
button{ cursor:pointer; }
button:hover{ background:#162040; }
.section{
    margin-bottom:25px;
    padding:15px;
    background:#0f172a;
    border:1px solid #1f2a44;
    border-radius:6px;
}
.section h2{
    margin-top:0;
    font-size:16px;
    color:#9db7ff;
}
.log{
    background:#05080f;
    border:1px solid #1f2a44;
    padding:10px;
    font-family:monospace;
    font-size:13px;
    white-space:pre-wrap;
    max-height:220px;
    overflow:auto;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}
th,td{
    border:1px solid #1f2a44;
    padding:6px;
    text-align:right;
}
th{ background:#121a2b; }
td:first-child,th:first-child{ text-align:left; }
.footer{
    text-align:center;
    font-size:12px;
    color:#7f8bb3;
    margin-top:30px;
}
.small{
  font-size:12px;
  color:#aab6e6;
}
</style>
</head>

<body>

<header>
<h1>üõ∞Ô∏è Spartizione Detriti ‚Äì OGame</h1>
</header>

<main>

<div class="section">
<h2>1Ô∏è‚É£ Carica CR da API</h2>
<input id="crApiId" style="width:100%" placeholder="cr-it-XXX-xxxxxxxxxxxxxxxx">
<br><br>
<button onclick="loadCRFromApi()">Carica CR da API</button>
<div class="small" style="margin-top:8px;">
Usa NoMoreAngel (engOut=on). Se il browser blocca il fetch, apri il link e incolla manualmente.
</div>
</div>

<div class="section">
<h2>2Ô∏è‚É£ Combat Report (testo)</h2>
<textarea id="crText" placeholder="Qui viene incollato il CR oppure puoi inserirlo a mano"></textarea>
<br><br>
<button onclick="analyzeCR()">Analizza CR</button>
</div>

<div class="section">
<h2>üìú Log</h2>
<div id="logBox" class="log"></div>
</div>

<div class="section">
<h2>üìä Attaccanti (blocchi sommati)</h2>
<div id="results"></div>
</div>

<div class="footer">
Versione stabile con lettore API CR
</div>

</main>

<script>
/* ===================== UTIL ===================== */
const LOG=[];
function log(msg){
  const t=new Date().toLocaleTimeString();
  LOG.push(`[${t}] ${msg}`);
  document.getElementById('logBox').textContent=LOG.join("\n");
}

function parseNum(v){
  if(v === null || v === undefined) return 0;
  const s = String(v).replace(/[^\d]/g,''); // tiene solo cifre (toglie . , spazi)
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

function decodeEntities(s){
  const ta = document.createElement('textarea');
  ta.innerHTML = s;
  return ta.value;
}

async function abortableFetch(url, timeoutMs=12000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    return await fetch(url, { signal: controller.signal });
  } finally {
    clearTimeout(t);
  }
}

async function fetchTextWithFallback(url, timeoutMs=12000){
  // 1) Direct (spesso bloccato da CORS)
  try{
    const res = await abortableFetch(url, timeoutMs);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.text();
  }catch(e1){
    // 2) Jina proxy (bypassa CORS per molte pagine)
    const clean = url.replace(/^https?:\/\//i,'');
    const jinaUrl = "https://r.jina.ai/http://" + clean; // proxy testuale
    const res2 = await abortableFetch(jinaUrl, timeoutMs);
    if(!res2.ok) throw new Error('HTTP '+res2.status);
    return await res2.text();
  }
}

/* ===================== API CR ===================== */
async function loadCRFromApi(){
  const apiId = document.getElementById('crApiId').value.trim();
  if(!apiId){
    log("‚ùå Inserisci un API ID CR");
    return;
  }

  const url = `https://nomoreangel.de/api-reader/?apiid=${encodeURIComponent(apiId)}&engOut=on`;
  log(`CR API: richiesta NoMoreAngel per ${apiId}...`);

  try{
    const html = await fetchTextWithFallback(url, 15000);

    // 1) se c'√® <pre> usiamo quello
    let crText = null;
    const preMatch = html.match(/<pre[^>]*>([\s\S]*?)<\/pre>/i);
    if(preMatch){
      crText = decodeEntities(preMatch[1]).trim();
    }

    // 2) altrimenti: nel testo (jina) troviamo da "General Information" o "Combat Report" in poi
    if(!crText){
      const idxGI = html.search(/General Information/i);
      const idxCR = html.search(/Combat Report/i);
      if(idxGI >= 0) crText = html.slice(idxGI).trim();
      else if(idxCR >= 0) crText = html.slice(idxCR).trim();
      else crText = html.trim();
    }

    if(!crText || crText.length < 50){
      log("‚ùå CR API: non sono riuscito a estrarre testo utile. Apri il link e incolla manualmente.");
      return;
    }

    document.getElementById('crText').value = crText;
    log("‚úÖ CR convertito (API) incollato nel box");
  }catch(e){
    log("‚ùå Errore fetch CR API: " + (e?.message || e));
  }
}

/* ===================== PARSER CR (NoMoreAngel engOut) ===================== */

// elenco ship EN (per ricomporre i Type multi-parola)
const KNOWN_SHIPS = [
  "Small Cargo","Large Cargo","Light Fighter","Heavy Fighter","Cruiser","Battleship",
  "Colony Ship","Recycler","Espionage Probe","Bomber","Solar Satellite","Destroyer",
  "Deathstar","Battlecruiser","Crawler","Reaper","Pathfinder",
  "Rocket Launcher","Light Laser","Heavy Laser","Gauss Cannon","Ion Cannon","Plasma Turret",
  "Small Shield Dome","Large Shield Dome"
];

// precompute set (lowercase)
const KNOWN_SET = new Map(KNOWN_SHIPS.map(s => [s.toLowerCase(), s]));

// segmentazione greedy (max 3 parole) per ricostruire "Light Fighter" ecc.
function splitShips(typePart){
  const words = typePart.trim().split(/\s+/).filter(Boolean);
  const ships = [];
  let i = 0;
  while(i < words.length){
    let found = null;
    // prova 3, 2, 1 parole
    for(let len=3; len>=1; len--){
      if(i+len > words.length) continue;
      const cand = words.slice(i, i+len).join(" ");
      const key = cand.toLowerCase();
      if(KNOWN_SET.has(key)){
        found = KNOWN_SET.get(key);
        i += len;
        ships.push(found);
        break;
      }
    }
    if(!found){
      // fallback: prendi parola singola (evita loop)
      ships.push(words[i]);
      i++;
    }
  }
  return ships;
}

// estrae tutte le coppie Type..Count.. dentro un blocco
function parseTypeCountPairs(blockText){
  const fleets = [];
  const re = /Type\s+([\s\S]*?)\s+Count\s+([\d\.\s]+)/gi;
  let m;
  while((m = re.exec(blockText)) !== null){
    const typePart = m[1].replace(/\s+/g,' ').trim();
    const countPart = m[2].replace(/\s+/g,' ').trim();

    const shipNames = splitShips(typePart);
    const counts = countPart.split(/\s+/).map(parseNum);

    const fleet = {};
    for(let i=0; i<shipNames.length; i++){
      const ship = shipNames[i];
      const qty = counts[i] || 0;
      if(!qty) continue;
      fleet[ship] = (fleet[ship] || 0) + qty;
    }
    fleets.push(fleet);
  }
  return fleets;
}

function mergeFleet(targetShips, fleet){
  for(const ship in fleet){
    targetShips[ship] = (targetShips[ship] || 0) + (fleet[ship] || 0);
  }
}

// estrae blocchi Attacker/Defender (eng) o Attaccante/Difensore (it)
// pattern: "Attacker [2:..] NAME [TAG] .... (fino a prossimo Attacker/Defender/Round/fine)"
function extractPlayerBlocks(txt){
  const blocks = [];
  const re = /(Attacker|Defender|Attaccante|Difensore)\s+\[[^\]]+\]\s+([^\[]+?)\s+\[[^\]]*\]([\s\S]*?)(?=(Attacker|Defender|Attaccante|Difensore)\s+\[|####\s*Round|Round\s+\d|$)/gi;
  let m;
  while((m = re.exec(txt)) !== null){
    blocks.push({
      role: m[1].toLowerCase().startsWith('att') ? 'attacker' : 'defender',
      name: (m[2] || '').trim(),
      body: (m[0] || '') // blocco completo
    });
  }
  return blocks;
}

function analyzeCR(){
  document.getElementById('results').innerHTML='';
  const txt = document.getElementById('crText').value || '';
  if(!txt.trim()){
    log("‚ùå Nessun CR da analizzare");
    return;
  }

  log("Analisi CR avviata (NoMoreAngel / testo)");

  const attackers = {}; // {name:{ships:{}}}
  const defenders = {};

  const blocks = extractPlayerBlocks(txt);
  if(!blocks.length){
    log("‚ùå Non ho trovato blocchi Attacker/Defender nel testo. Controlla che sia engOut=on oppure incolla il CR completo.");
    return;
  }

  for(const b of blocks){
    const name = b.name || '(sconosciuto)';
    const dict = (b.role === 'attacker') ? attackers : defenders;

    if(!dict[name]){
      dict[name] = { ships:{} };
      log(`‚ûï ${b.role === 'attacker' ? 'Attaccante' : 'Difensore'}: ${name}`);
    }else{
      log(`üîÅ Blocco aggiuntivo per ${name} (${b.role})`);
    }

    // estrai tutte le coppie Type/Count nel blocco e mergia
    const fleets = parseTypeCountPairs(b.body);
    for(const fleet of fleets){
      mergeFleet(dict[name].ships, fleet);
    }
  }

  const names = Object.keys(attackers);
  log(`Attaccanti rilevati: ${names.length}`);

  // tabella risultati (attaccanti)
  let html = '<table><tr><th>Attaccante</th><th>Navi totali</th><th>Dettaglio</th></tr>';
  for(const n of names){
    const ships = attackers[n].ships;
    const tot = Object.values(ships).reduce((a,b)=>a+b,0);

    // dettaglio compatto (top 8)
    const entries = Object.entries(ships).sort((a,b)=>b[1]-a[1]);
    const top = entries.slice(0,8).map(([k,v]) => `${k}: ${v.toLocaleString('it-IT')}`).join(' ‚Ä¢ ');
    const more = entries.length > 8 ? ` (+${entries.length-8} altri)` : '';

    html += `<tr>
      <td>${escapeHtml(n)}</td>
      <td>${tot.toLocaleString('it-IT')}</td>
      <td style="text-align:left">${escapeHtml(top + more)}</td>
    </tr>`;
  }
  html += '</table>';

  document.getElementById('results').innerHTML = html;
  log("‚úÖ Analisi completata");
}

function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

log("Pronto. Carica CR via API o incolla manualmente.");
</script>

</body>
</html>
