<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spartizione Detriti OGame</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Rajdhani,system-ui;
  background:#050a10;
  color:#dbe7ff;
}
.wrap{max-width:1100px;margin:auto;padding:16px}
.card{
  background:#0e1728;
  border:1px solid #233455;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}
h1,h2{font-family:Orbitron;margin:0 0 8px}
input,textarea,button{
  width:100%;margin:6px 0;padding:10px;
  background:#0a1220;color:#dbe7ff;
  border:1px solid #233455;border-radius:10px;
}
button{cursor:pointer;font-weight:600}
pre{white-space:pre-wrap;font-size:12px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #233455;padding:6px;font-size:12px;text-align:right}
th:first-child,td:first-child{text-align:left}
.good{color:#39d98a}
.bad{color:#ff5c5c}
.hidden{display:none}
</style>
</head>

<body>
<div class="wrap">

<h1>Spartizione Detriti OGame</h1>

<div class="card">
  <h2>1) Carica CR (NoMoreAngel)</h2>
  <input id="crApiId" placeholder="cr-it-254-..." />
  <button id="btnLoadCR">Carica CR</button>
  <pre id="log"></pre>
</div>

<div id="app" class="hidden">

<div class="card">
  <h2>2) RR</h2>
  <textarea id="rrIds" placeholder="rr-it-... (uno per riga)"></textarea>
  <button id="btnLoadRR">Carica RR</button>
</div>

<div class="card">
  <h2>Risultati</h2>
  <div id="results"></div>
</div>

</div>
</div>

<script>
/* ================= UTILS ================= */
const COSTS={
 "Caccia Leggero":[3000,1000,0],
 "Caccia Pesante":[6000,4000,0],
 "Incrociatore":[20000,7000,2000],
 "Nave da battaglia":[45000,15000,0],
 "Corazzata":[60000,50000,15000],
 "Incrociatore da Battaglia":[30000,40000,15000],
 "Reaper":[85000,55000,20000],
 "Pathfinder":[8000,15000,8000],
 "Cargo leggero":[2000,2000,0],
 "Cargo Pesante":[6000,6000,0],
 "Sonda spia":[0,1000,0],
 "Morte Nera":[5000000,4000000,1000000]
};

const fmt=n=>Math.round(n).toLocaleString("it-IT");
const num=s=>Number(String(s).replace(/[^\d]/g,""))||0;
const log=t=>document.getElementById("log").textContent+=t+"\n";

/* ================= STATE ================= */
const STATE={cr:null,rr:{}};

  /* ===================== FETCH HELPERS (CORS SAFE) ===================== */
function abortableFetch(url, timeoutMs){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeoutMs);
  return fetch(url, { signal: controller.signal }).finally(()=>clearTimeout(id));
}

async function fetchTextWithFallback(url, timeoutMs=15000){
  try{
    const res = await abortableFetch(url, timeoutMs);
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }catch(e){
    // fallback CORS: r.jina.ai
    const clean = String(url).replace(/^https?:\/\//i,"");
    const jinaUrl = "https://r.jina.ai/http://" + clean;
    const res2 = await abortableFetch(jinaUrl, timeoutMs);
    if(!res2.ok) throw new Error("HTTP " + res2.status);
    return await res2.text();
  }
}

/* ===================== CR LOADER (FIX ID) ===================== */
let CR_TEXT = "";

document.getElementById("btnLoadCRApi").addEventListener("click", async ()=>{
  const apiId = (document.getElementById("crApiId").value || "").trim();
  if(!apiId){
    setCrStatus(false, "Inserisci un API ID CR.");
    return;
  }

  setCrStatus(null, "Caricamento CR…");
  log(`CR: richiesta NoMoreAngel per ${apiId}…`);

  const timeoutMs = parseNum(document.getElementById("timeoutMs")?.value) || 20000;

  // accetta sia apiid che link completo
  const url = /^https?:\/\//i.test(apiId)
    ? apiId
    : `https://nomoreangel.de/api-reader/?apiid=${encodeURIComponent(apiId)}&engOut=on`;

  try{
    const raw = await fetchTextWithFallback(url, timeoutMs);

    const classic = parseNmaApiReaderToClassic(raw);
    if(!classic){
      setCrStatus(false, "Errore: non riesco a convertire (manca Initial/Round).");
      log("❌ Conversione CR fallita.");
      return;
    }

    CR_TEXT = classic;
    STATE.cr = parseCRText(CR_TEXT);

    setCrStatus(true, "CR OK.");
    log("✅ CR caricato e analizzato.");

    showApp2();
    recomputeAndRender();
  }catch(e){
    setCrStatus(false, "Errore fetch CR.");
    log("❌ Errore fetch CR: " + (e?.message || e));
  }
});

/* ================= NMA → CLASSIC (CORRETTO) ================= */
function parseNmaApiReaderToClassic(raw){
  let t=raw;
  if(t.includes("Markdown Content:"))
    t=t.split("Markdown Content:")[1];

  const initial={}, final={}, lost={};
  const nameMap={};

  // INITIAL
  [...t.matchAll(/Attacker\s+\[[^\]]+\]\s+([^\[]+?)\s+\[([^\]]+)\][\s\S]*?Type\s+([\s\S]*?)\s+Count\s+([\s\S]*?)(?=Weapon|Attacker|Defender|$)/g)]
  .forEach(m=>{
    const key=`${m[1].trim()} [${m[2].trim()}]`;
    nameMap[m[1].trim()]=key;
    if(!initial[key]) initial[key]={};

    const ships=[...m[3].matchAll(/[A-Za-z ]+/g)].map(x=>x[0].trim());
    const nums=[...m[4].matchAll(/[\d\.,]+/g)].map(x=>num(x[0]));

    ships.forEach((s,i)=>{
      initial[key][s]=(initial[key][s]||0)+(nums[i]||0);
    });
  });

  // ROUNDS (LOST)
  [...t.matchAll(/Attacker\s+([A-Za-z0-9_À-ÿ]+)[\s\S]*?Count[\s\S]*?Lost([\s\S]*?)(?=Attacker|Defender|$)/g)]
  .forEach(m=>{
    const key=nameMap[m[1]]; if(!key) return;
    if(!lost[key]) lost[key]={};
    const ships=[...m[0].matchAll(/[A-Za-z ]+/g)].map(x=>x[0].trim());
    const nums=[...m[2].matchAll(/[\d\.,]+/g)].map(x=>num(x[0]));
    ships.forEach((s,i)=>{
      lost[key][s]=(lost[key][s]||0)+(nums[i]||0);
    });
  });

  // FINAL = initial − lost
  Object.entries(initial).forEach(([p,ships])=>{
    final[p]={};
    Object.entries(ships).forEach(([s,q])=>{
      final[p][s]=Math.max(0,q-(lost[p]?.[s]||0));
    });
  });

  return {initial,final,lost};
}

/* ================= CR TEXT PARSER ================= */
function parseCRText(cr){
  const out={attackers:{}};
  Object.entries(cr.initial).forEach(([p,ships])=>{
    out.attackers[p]={initial:ships,final:cr.final[p],lost:cr.lost[p]};
  });
  return out;
}

/* ================= CALCOLO ================= */
function compute(){
  const players=Object.keys(STATE.cr.attackers);
  const res=[];
  players.forEach(p=>{
    let m=0,c=0,d=0;
    Object.entries(STATE.cr.attackers[p].lost||{}).forEach(([s,q])=>{
      const cost=COSTS[s]; if(!cost) return;
      m+=cost[0]*q; c+=cost[1]*q; d+=cost[2]*q;
    });
    res.push({p,m,c,d});
  });
  return res;
}

/* ================= UI ================= */
document.getElementById("btnLoadCR").onclick=async()=>{
  const id=crApiId.value.trim();
  log("Carico CR...");
  const r=await fetch(`https://nomoreangel.de/api-reader/?apiid=${id}&engOut=on`).then(r=>r.text());
  const classic=parseNmaApiReaderToClassic(r);
  STATE.cr=parseCRText(classic);
  log("CR OK");
  document.getElementById("app").classList.remove("hidden");

  const rows=compute().map(x=>`
    <tr>
      <td>${x.p}</td>
      <td class="bad">${fmt(x.m)}</td>
      <td class="bad">${fmt(x.c)}</td>
      <td class="bad">${fmt(x.d)}</td>
    </tr>`).join("");

  results.innerHTML=`
    <table>
      <thead><tr><th>Giocatore</th><th>M</th><th>C</th><th>D</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
};
</script>
</body>
</html>
