<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OGame — CR Reader (Nomoreangel + Proxy)</title>
<style>
:root{
  --bg:#0b1420; --panel:#0f1d2e; --line:#2a3b52; --text:#d7e2f0; --muted:#9fb1c7; --accent:#ffd36a;
  --shadow:0 10px 25px rgba(0,0,0,.35); --radius:14px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:var(--sans); color:var(--text);
  background: radial-gradient(900px 500px at 20% -10%, rgba(255,211,106,.12), transparent 60%),
             radial-gradient(700px 450px at 90% 0%, rgba(120,240,176,.10), transparent 55%),
             linear-gradient(180deg, var(--bg), #070d16 75%);
  min-height:100vh;
}
header{max-width:980px;margin:22px auto 10px;padding:0 16px;display:flex;justify-content:space-between;gap:12px;align-items:center}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(180deg, rgba(255,211,106,.25), rgba(255,211,106,.06));
border:1px solid rgba(255,211,106,.35);box-shadow:var(--shadow);position:relative}
.logo:after{content:"";position:absolute;inset:7px;border-radius:8px;border:1px dashed rgba(255,211,106,.55);opacity:.7}
h1{font-size:16px;margin:0;letter-spacing:.2px}
.sub{margin:0;color:var(--muted);font-size:12px}
.container{max-width:980px;margin:0 auto;padding:0 16px 34px}
.card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card h2{margin:0;font-size:13px;padding:12px 14px;background:linear-gradient(180deg, rgba(15,29,46,.88), rgba(12,24,39,.85));
border-bottom:1px solid rgba(42,59,82,.6);display:flex;justify-content:space-between;align-items:center;gap:10px}
.pill{font-size:12px;color:var(--muted);background:rgba(20,38,59,.8);border:1px solid rgba(42,59,82,.7);padding:2px 8px;border-radius:999px}
.content{padding:12px 14px;background:rgba(12,24,39,.72)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.field{flex:1 1 200px;min-width:200px}
label{display:block;margin:0 0 6px;font-size:12px;color:var(--muted)}
input, textarea, button{font:inherit}
input{
  width:100%;padding:8px 10px;border-radius:12px;border:1px solid rgba(42,59,82,.85);
  background:rgba(7,13,22,.55);color:var(--text);outline:none
}
input:focus{border-color:rgba(255,211,106,.55);box-shadow:0 0 0 3px rgba(255,211,106,.10)}
button{
  background:linear-gradient(180deg, rgba(255,211,106,.18), rgba(255,211,106,.07));
  border:1px solid rgba(255,211,106,.35);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.22)
}
button:hover{filter:brightness(1.06)}
button:active{transform:translateY(1px)}
button.ghost{background:transparent;border:1px solid rgba(42,59,82,.85)}
.note{margin:10px 0 0;color:var(--muted);font-size:12px}
.grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
pre, textarea{
  width:100%;min-height:260px;padding:10px 12px;border-radius:12px;border:1px solid rgba(42,59,82,.85);
  background:rgba(7,13,22,.65);color:var(--text);outline:none;font-family:var(--mono);font-size:12px;line-height:1.35;white-space:pre-wrap
}
.small{font-size:11px}
table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid rgba(42,59,82,.85);border-radius:12px;overflow:hidden;background:rgba(7,13,22,.35)}
th,td{padding:10px;border-bottom:1px solid rgba(42,59,82,.55);font-size:12px}
th{background:rgba(15,29,46,.65);color:var(--muted);text-align:left}
tr:last-child td{border-bottom:none}
.num{font-family:var(--mono);font-variant-numeric:tabular-nums;text-align:right}
.name{font-weight:650}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi .k{flex:1 1 200px;padding:10px 12px;border:1px solid rgba(42,59,82,.85);border-radius:12px;background:rgba(7,13,22,.35)}
.kpi .t{color:var(--muted);font-size:11px}
.kpi .v{font-family:var(--mono);margin-top:4px;font-size:13px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>CR Reader — Nomoreangel</h1>
      <p class="sub">Carica un CR via proxy, estrai testo e leggi: attaccanti + DF</p>
    </div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
    <button class="ghost" id="btnExample">Incolla esempio</button>
    <button id="btnParse">Parse</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>1) Caricamento CR <span class="pill">apiid</span></h2>
    <div class="content">
      <div class="row">
        <div class="field">
          <label>API ID (CR)</label>
          <input id="apiCrId" placeholder="es. cr-it-269-..." />
        </div>
        <div class="field" style="flex:0 0 auto;min-width:auto">
          <label>&nbsp;</label>
          <button id="btnLoadCR">Carica da API</button>
        </div>
      </div>
      <p class="note small" id="status">Pronto.</p>
      <div class="grid">
        <div>
          <label style="margin-top:12px">Testo estratto (editabile)</label>
          <textarea id="crText" spellcheck="false" placeholder="Qui comparirà il testo estratto dal report..."></textarea>
        </div>
        <div>
          <label style="margin-top:12px">Debug</label>
          <pre id="debug">—</pre>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h2>2) Risultato <span class="pill">output</span></h2>
    <div class="content">
      <div class="kpi">
        <div class="k"><div class="t">DF (M/C/D)</div><div class="v" id="kpiDf">—</div></div>
        <div class="k"><div class="t">Attaccanti</div><div class="v" id="kpiN">—</div></div>
      </div>

      <div style="margin-top:12px;overflow:auto;max-height:420px">
        <table>
          <thead><tr><th>Giocatore</th><th class="num">Peso (facoltativo)</th></tr></thead>
          <tbody id="tbodyOut"></tbody>
        </table>
      </div>

      <p class="note small">Nota: “Peso” è calcolato solo se nel testo ci sono righe nave+quantità (CR classico). Se hai solo RAW stdClass, mostro i nomi e DF.</p>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  // ✅ Usa il tuo proxy (stabile)
  const PROXY_BASE = "https://ogame-api-proxy.matiasquiroz87.workers.dev/?apiid=";

  function parseIntOgame(x){
    if(x==null) return 0;
    const s = String(x).trim().replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? Math.trunc(n) : 0;
  }

  function fmt(n){
    if(!Number.isFinite(n)) return "—";
    return n.toLocaleString('it-IT');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  // Estrazione testo dal HTML di nomoreangel
  function extractTextFromHtml(html){
    const doc = new DOMParser().parseFromString(html, "text/html");
    const pre = doc.querySelector("pre");
    if(pre && pre.textContent && pre.textContent.trim().length>0) return pre.textContent.trim();
    const ta = doc.querySelector("textarea");
    if(ta && ta.value && ta.value.trim().length>0) return ta.value.trim();
    return (doc.body ? doc.body.textContent : html).trim();
  }

  function parseCR(text){
    const debug = [];
    const out = { attackers: [], df: null, debug: "", weights:{} };

    const t = String(text||"");
    const lines = t.split(/\r?\n/);

    const reDF_en = /float\s+([\d\.,]+)\s+metal,\s+([\d\.,]+)\s+crystal\s+and\s+([\d\.,]+)\s+deuterium/i;
    const reDF_it = /fluttuano\s+([\d\.,]+)\s+metallo,\s+([\d\.,]+)\s+cristallo\s+e\s+([\d\.,]+)\s+deuterio/i;

    const attackersClassic = [];
    for(const raw of lines){
      const line = raw.trim();
      if(!line) continue;
      const mAtt = line.match(/^Attaccante\s+(.+?)(\s+\[|$)/i);
      if(mAtt){
        attackersClassic.push(mAtt[1].trim());
      }
      if(!out.df){
        const m = line.match(reDF_en) || line.match(reDF_it);
        if(m){
          out.df = { m: parseIntOgame(m[1]), c: parseIntOgame(m[2]), d: parseIntOgame(m[3]) };
        }
      }
    }
    if(attackersClassic.length){
      out.attackers = [...new Set(attackersClassic)];
      debug.push(`Trovati attaccanti (classico): ${out.attackers.length}`);
    }

    const looksRaw = /stdClass Object\s*\(/.test(t);
    if(looksRaw) debug.push("Rilevato formato RAW stdClass.");

    if(!out.df && looksRaw){
      const mM = t.match(/\bmetal_(?:to|in)_debris(?:field)?\]?\s*=>\s*([0-9]+)/i);
      const mC = t.match(/\bcrystal_(?:to|in)_debris(?:field)?\]?\s*=>\s*([0-9]+)/i);
      const mD = t.match(/\bdeuterium_(?:to|in)_debris(?:field)?\]?\s*=>\s*([0-9]+)/i);
      if(mM && mC){
        out.df = { m: parseIntOgame(mM[1]), c: parseIntOgame(mC[1]), d: mD ? parseIntOgame(mD[1]) : 0 };
        debug.push(`DF trovato (RAW): M=${out.df.m} C=${out.df.c} D=${out.df.d}`);
      }
    }

    if(out.attackers.length===0 && looksRaw){
      const names = new Set();
      let m;
      const re1 = /\battacker_name\]?\s*=>\s*([^\n\r\]]+)/ig;
      while((m = re1.exec(t)) !== null){
        const name = String(m[1]).trim().replace(/^\(|\)+$/g,'').replace(/^"|"$/g,'');
        if(name && name.length<40) names.add(name);
      }
      const re2 = /\bowner_name\]?\s*=>\s*([^\n\r]+)/ig;
      while((m = re2.exec(t)) !== null){
        const name = String(m[1]).trim().replace(/^\(|\)+$/g,'').replace(/^"|"$/g,'');
        if(name && name.length<40) names.add(name);
      }
      if(names.size){
        out.attackers = [...names];
        debug.push(`Trovati nomi (RAW heuristics): ${out.attackers.length}`);
      } else {
        debug.push("Non ho trovato 'attacker_name' o 'owner_name' nel RAW.");
      }
    }

    // Peso (solo classico, super light)
    const COSTS = {
      "Cargo pesante": {m:6000,c:6000,d:0},
      "Caccia leggero": {m:3000,c:1000,d:0},
      "Caccia pesante": {m:6000,c:4000,d:0},
      "Incrociatore": {m:20000,c:7000,d:2000},
      "Nave da battaglia": {m:45000,c:15000,d:0},
      "Bombardiere": {m:50000,c:25000,d:15000},
      "Corazzata": {m:60000,c:50000,d:15000},
      "Incrociatore da Battaglia": {m:30000,c:40000,d:15000},
      "Reaper": {m:85000,c:55000,d:20000},
      "Pathfinder": {m:8000,c:15000,d:8000},
    };
    const alias = new Map([
      ["Cargo Pesante","Cargo pesante"],["Cargo pesante","Cargo pesante"],
      ["Caccia Leggero","Caccia leggero"],["Caccia leggero","Caccia leggero"],
      ["Caccia Pesante","Caccia pesante"],["Caccia pesante","Caccia pesante"],
      ["Incrociatore","Incrociatore"],["Nave da battaglia","Nave da battaglia"],
      ["Bombardiere","Bombardiere"],["Corazzata","Corazzata"],
      ["Incrociatore da Battaglia","Incrociatore da Battaglia"],
      ["Reaper","Reaper"],["Pathfinder","Pathfinder"],
    ]);
    if(attackersClassic.length){
      let current = null;
      let inInitial = true;
      for(const raw of lines){
        const line = raw.trim();
        if(!line) continue;
        if(line.toLowerCase().includes("dopo la battaglia")){ inInitial = false; current = null; }
        if(!inInitial) continue;
        const mAtt = line.match(/^Attaccante\s+(.+?)(\s+\[|$)/i);
        if(mAtt){
          current = mAtt[1].trim();
          if(!(current in out.weights)) out.weights[current] = 0;
          continue;
        }
        const mShip = line.match(/^([A-Za-zÀ-ÿ .]+?)\s+([\d\.,]+)(?:\s*\(|$)/);
        if(mShip && current){
          const label = String(mShip[1]).trim().replace(/\.+$/,'');
          const cnt = parseIntOgame(mShip[2]);
          const key = alias.get(label);
          if(key && COSTS[key]){
            const c = COSTS[key];
            out.weights[current] += cnt * (c.m+c.c+c.d);
          }
        }
      }
    }

    out.debug = debug.join("\n");
    return out;
  }

  async function loadCR(){
    const apiid = $("apiCrId").value.trim();
    if(!apiid) return;
    const url = PROXY_BASE + encodeURIComponent(apiid);

    $("status").textContent = `Carico… ${url}`;
    $("debug").textContent = "—";

    try{
      const res = await fetch(url, { cache: "no-store" });
      const html = await res.text();
      if(!res.ok) throw new Error("HTTP " + res.status);

      const extracted = extractTextFromHtml(html);
      $("crText").value = extracted;
      $("status").textContent = `OK (status=${res.status}). Testo estratto: ${extracted.length} caratteri.`;
      doParse();
    }catch(e){
      $("status").textContent = `Errore: ${e.message}`;
      $("debug").textContent = `Aprilo via http:// (server locale o hosting).\nSe lo apri da file://, Safari/Chrome possono bloccare fetch.`;
      alert(e.message);
    }
  }

  function doParse(){
    const parsed = parseCR($("crText").value);
    $("debug").textContent = parsed.debug || "—";

    const df = parsed.df;
    $("kpiDf").textContent = df ? `${fmt(df.m)} / ${fmt(df.c)} / ${fmt(df.d)}` : "—";
    $("kpiN").textContent = parsed.attackers.length ? String(parsed.attackers.length) : "—";

    const tbody = $("tbodyOut");
    tbody.innerHTML = "";
    if(!parsed.attackers.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="name">—</td><td class="num">—</td>`;
      tbody.appendChild(tr);
      return;
    }
    parsed.attackers.forEach(name=>{
      const tr = document.createElement("tr");
      const w = parsed.weights && parsed.weights[name] ? parsed.weights[name] : 0;
      tr.innerHTML = `<td><span class="name">${escapeHtml(name)}</span></td><td class="num">${w?fmt(w):"—"}</td>`;
      tbody.appendChild(tr);
    });
  }

  $("btnLoadCR").addEventListener("click", loadCR);
  $("btnParse").addEventListener("click", doParse);

  $("btnExample").addEventListener("click", ()=>{
    $("crText").value = `Il 28-01-2026 --:--:--, le seguenti flotte si scontrano in combattimento:\n\nAttaccante Abubu [U E]\n________________________________________________\nCargo Pesante 1\nCaccia Leggero 3.226.909\nCaccia Pesante 177.230\nIncrociatore 557.550\nNave da battaglia 151.773\nCorazzata 89.802\nIncrociatore da Battaglia 462.085\nReaper 129.700\nPathfinder 96.320\n\nAttaccante Pablito [B V]\n________________________________________________\nCaccia Leggero 2.052.722\nCaccia Pesante 135.754\nIncrociatore 341.975\nNave da battaglia 94.921\nBombardiere 20.906\nCorazzata 102.324\nIncrociatore da Battaglia 203.647\nReaper 87.875\nPathfinder 59.309\n\nAt these space coordinates now float 8.451.301.052 metal, 6.135.502.953 crystal and 1.725.266.027 deuterium.`;
    doParse();
  });

})();
</script>
</body>
</html>
